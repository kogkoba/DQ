<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <!-- ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®ãŸã‚ã®ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆè¨­å®š -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‰ãƒ©ã‚¯ã‚¨é¢¨ã‚¯ã‚¤ã‚ºRPG çµ±åˆã‚µãƒ³ãƒ—ãƒ«</title>
  <style>
    /* ---------- å…±é€šè¨­å®š ---------- */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: sans-serif;
      background-color: #222;
      color: #fff;
    }
    /* ---------- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ---------- */
    #loginScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      background: black;
    }
    #loginScreen input, #loginScreen button {
      font-size: 18px;
      padding: 5px;
      margin: 10px;
    }
    /* ---------- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ ---------- */
    #titleScreen {
      display: none; /* ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è¡¨ç¤º */
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      background: black;
    }
    #startButton {
      font-size: 24px;
      padding: 10px 20px;
      cursor: pointer;
      border: 2px solid #fff;
      background: #444;
      color: #fff;
      border-radius: 5px;
    }
    /* ---------- ã‚²ãƒ¼ãƒ ç”»é¢å…¨ä½“ ---------- */
    #gameContainer {
      display: none;
      width: 100%;
      height: 100%;
    }
    /* ---------- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º ---------- */
    #status {
      padding: 10px;
      text-align: center;
      font-size: 18px;
      background-color: #111;
    }
    /* ---------- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”»é¢ ---------- */
    #gameArea {
      position: relative;
      width: 100%;
      height: calc(100% - 50px);
      background: url("https://lh3.googleusercontent.com/d/1jDckidA8IqAdhUncYX09kzOQd2IqanYQ") no-repeat center center;
      background-size: cover;
      overflow: hidden;
    }
    /* å‹‡è€…ç”»åƒ */
    #player {
      position: absolute;
      width: 30px;
      height: auto;
    }
    /* ---------- D-Pad ---------- */
    #dpad {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 150px;
      height: 150px;
      display: grid;
      grid-template-areas:
        ".    up    ."
        "left center right"
        ".    down  .";
      grid-gap: 10px;
    }
    .dpad-button {
      width: 50px;
      height: 50px;
      background: rgba(0,0,0,0.3);
      border: 2px solid #fff;
      border-radius: 5px;
      cursor: pointer;
      touch-action: none;
      user-select: none;
    }
    .up    { grid-area: up; }
    .down  { grid-area: down; }
    .left  { grid-area: left; }
    .right { grid-area: right; }
    .center{ grid-area: center; }
    /* ---------- æˆ¦é—˜ç”»é¢ ---------- */
    #battle-screen {
      display: none;
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: black;
      padding: 10px;
      text-align: center;
      z-index: 100;
    }
    #top-text-box {
      border: 2px solid white;
      padding: 5px;
      margin-bottom: 5px;
      min-height: 40px;
      font-size: 16px;
    }
    /* æ•µè¡¨ç¤º */
    #enemy-container {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-bottom: 5px;
    }
    .monster {
      width: 50px;
      height: 50px;
      object-fit: contain;
    }
    /* ã‚¯ã‚¤ã‚ºç”»åƒ */
    #quiz-image {
      display: none;
      width: 150px;
      height: 150px;
      margin: 5px auto;
    }
    /* é¸æŠè‚¢ */
    .choice-button {
      display: block;
      margin: 5px auto;
      padding: 5px;
      width: 150px;
      font-size: 16px;
    }
    /* ---------- ãƒãƒ¼ãƒˆè¡¨ç¤ºç”¨ã‚³ãƒ³ãƒ†ãƒŠ ---------- */
    #hearts-container {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
    }
    .heart {
      font-size: 24px;
      color: red;
    }
    /* ---------- è§£èª¬ã¯ä¸è¦ ---------- */
    #explanation {
      display: none;
    }
    #zaorikuButton {
      display: none;
      font-size: 18px;
      padding: 5px 10px;
      margin-top: 10px;
      cursor: pointer;
    }
    /* ---------- å††æ‹¡å¤§æ¼”å‡ºç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ---------- */
    #transition-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 200;
      display: none;
      pointer-events: none;
    }
    #transition-circle {
      position: absolute;
      width: 200vmax;
      height: 200vmax;
      background: black;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      transition: transform 0.8s ease-out;
    }
    #transition-circle.active {
      transform: translate(-50%, -50%) scale(1);
    }
    /* ---------- ã‚·ã‚§ã‚¤ã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ---------- */
    @keyframes shake {
      0% { transform: translate(0, 0); }
      20% { transform: translate(-5px, 0); }
      40% { transform: translate(5px, 0); }
      60% { transform: translate(-5px, 0); }
      80% { transform: translate(5px, 0); }
      100% { transform: translate(0, 0); }
    }
    .shake {
      animation: shake 0.5s;
    }
    /* ---------- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ ---------- */
    @media (max-width: 600px) {
      #status { font-size: 16px; padding: 10px; }
      #top-text-box { font-size: 14px; padding: 5px; }
      .choice-button { width: 120px; font-size: 14px; }
      #player { width: 25px; }
      #dpad {
        width: 120px;
        height: 120px;
        grid-gap: 5px;
      }
      .dpad-button {
        width: 40px;
        height: 40px;
      }
      .heart { font-size: 20px; }
    }
  </style>
</head>
<body>

  <!-- â–¼ DOMContentLoaded ã§åˆæœŸåŒ–ï¼ˆBGMã¯ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã§é–‹å§‹ï¼‰ -->
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®£è¨€
    let quizBGM; // ã‚¯ã‚¤ã‚ºBGMç”¨ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´ 
    let inBattle = false;
    let isBgmPlaying = false;
    const STEP = 20;
    let lastEncounterSteps = 0;
    let encounterThreshold = getRandomEncounterThreshold();
    function getRandomEncounterThreshold() {
      return Math.floor(Math.random() * 11) + 5;
    }

    document.addEventListener("DOMContentLoaded", () => {
      console.log("âœ… DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ");

      // BGMã¯ã™ã¹ã¦OFFã§é–‹å§‹
      stopFieldBGM();
      stopBattleBGM();
      stopQuizBGM();
      isBgmPlaying = false;

      const bgmButton = document.getElementById("bgmToggleButton");
      if (bgmButton) {
        bgmButton.textContent = "ğŸ”‡ BGM OFF";
      }

      // ã‚¯ã‚¤ã‚ºBGMã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«å–å¾—ï¼†ãƒ«ãƒ¼ãƒ—è¨­å®š
      quizBGM = document.getElementById("quizBGM");
      if (quizBGM) {
        quizBGM.loop = true;
      } else {
        console.warn("âŒ quizBGMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼");
      }

      updateBgmButton();
    });

    // ã‚¯ã‚¤ã‚ºBGMã®å†ç”Ÿï¼åœæ­¢ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
    function playQuizBGM() {
      if (!quizBGM) {
        console.warn("âŒ quizBGMãŒæœªå®šç¾©ã§ã™");
        return;
      }
      if (!isBgmPlaying) {
        console.log("ğŸ”‡ BGMãŒOFFã®ãŸã‚ã€ã‚¯ã‚¤ã‚ºBGMã¯å†ç”Ÿã—ã¾ã›ã‚“");
        return;
      }
      // æ—¢ã«å†ç”Ÿä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
      if (!quizBGM.paused) {
        console.log("ğŸµ ã‚¯ã‚¤ã‚ºBGMã¯ã™ã§ã«å†ç”Ÿä¸­");
        return;
      }
      quizBGM.play().catch(err => console.warn("ã‚¯ã‚¤ã‚ºBGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
    }
    function stopQuizBGM() {
      if (!quizBGM) {
        console.warn("âŒ quizBGMãŒæœªå®šç¾©ã§ã™");
        return;
      }
      quizBGM.pause();
      quizBGM.currentTime = 0;
      console.log("â¹ ã‚¯ã‚¤ã‚ºBGMã‚’åœæ­¢ã—ã¾ã—ãŸ");
    }

    // BGMç®¡ç†ï¼ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ»ãƒãƒˆãƒ«ï¼‰
    const fieldBGM = document.getElementById("fieldBGM");
    const battleBGM = document.getElementById("battleBGM");
    function playFieldBGM() {
      if (!isBgmPlaying) {
        console.log("â¸ BGMã¯OFFãªã®ã§å†ç”Ÿã—ã¾ã›ã‚“");
        return;
      }
      fieldBGM.currentTime = 0;
      fieldBGM.play().catch(err => console.warn("ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
    }
    function stopFieldBGM() {
      fieldBGM.pause();
      fieldBGM.currentTime = 0;
    }
    let isBattleBGMPlaying = false;
    function playBattleBGM() {
      if (!isBgmPlaying) {
        console.log("ğŸ”‡ BGMãŒOFFãªã®ã§ãƒãƒˆãƒ«BGMã‚’æµã—ã¾ã›ã‚“");
        return;
      }
      if (isBattleBGMPlaying) {
        console.log("ğŸµ ãƒãƒˆãƒ«BGMã¯ã™ã§ã«å†ç”Ÿä¸­");
        return;
      }
      battleBGM.currentTime = 0;
      battleBGM.play().then(() => {
        isBattleBGMPlaying = true;
      }).catch(err => console.warn("æˆ¦é—˜BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
    }
    function stopBattleBGM() {
      battleBGM.pause();
      battleBGM.currentTime = 0;
      isBattleBGMPlaying = false;
    }
    function toggleBGM() {
      isBgmPlaying = !isBgmPlaying;
      const button = document.getElementById("bgmToggleButton");
      if (isBgmPlaying) {
        button.textContent = "ğŸµ BGM ON";
        playFieldBGM();
      } else {
        button.textContent = "ğŸ”‡ BGM OFF";
        stopFieldBGM();
        stopBattleBGM();
        stopQuizBGM();
      }
    }
    function updateBgmButton() {
      const button = document.getElementById("bgmToggleButton");
      if (!button) {
        console.warn("âŒ BGMãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼");
        return;
      }
      button.textContent = isBgmPlaying ? "ğŸµ BGM ON" : "ğŸ”‡ BGM OFF";
    }
  </script>
  <!-- â–² DOMContentLoaded åˆæœŸåŒ– -->

  <!-- ---------- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ---------- -->
  <div id="loginScreen">
    <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
    <input type="text" id="playerNameInput" placeholder="åå‰ã‚’å…¥åŠ›">
    <button id="loginButton">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>

  <!-- ---------- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ ---------- -->
  <div id="titleScreen">
    <h1>ãƒ‰ãƒ©ã‚¯ã‚¨é¢¨ã‚¯ã‚¤ã‚ºRPG</h1>
    <button id="startButton" onclick="startGame()">â–¶ ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>

  <!-- ---------- ã‚²ãƒ¼ãƒ ç”»é¢å…¨ä½“ ---------- -->
  <div id="gameContainer">
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div id="status">
      ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®HP: <span id="hp">100</span> / ãƒ¬ãƒ™ãƒ«: <span id="level">1</span>
      <div id="bgmToggleContainer">
        <!-- â–¼ BGMã‚ªãƒ³ã‚ªãƒ•ãƒœã‚¿ãƒ³ -->
        <button id="bgmToggleButton" onclick="toggleBGM()">ğŸ”‡ BGM OFF</button>
      </div>
    </div>

    <!-- ---------- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”»é¢ ---------- -->
    <div id="gameArea">
      <img id="player" src="https://lh3.googleusercontent.com/d/1peHOi70oOmL8c9v3OQydE5N-9R0PB6vh" alt="hero">
      <div id="dpad">
        <div class="dpad-button up" onclick="movePlayer(0, -STEP)"></div>
        <div class="dpad-button left" onclick="movePlayer(-STEP, 0)"></div>
        <div class="dpad-button center"></div>
        <div class="dpad-button right" onclick="movePlayer(STEP, 0)"></div>
        <div class="dpad-button down" onclick="movePlayer(0, STEP)"></div>
      </div>
      <!-- ---------- å††æ‹¡å¤§æ¼”å‡ºç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ---------- -->
      <div id="transition-overlay">
        <div id="transition-circle"></div>
      </div>
    </div>

    <!-- ---------- æˆ¦é—˜ç”»é¢ ---------- -->
    <div id="battle-screen">
      <div id="top-text-box">mamãŒã‚ã‚‰ã‚ã‚ŒãŸï¼</div>
      <div id="enemy-container"></div>
      <img id="quiz-image" src="">
      <div id="choice-area"></div>
      <div id="hearts-container"></div>
      <button id="zaorikuButton" onclick="onZaoriku()">ã‚¶ã‚ªãƒªã‚¯</button>
    </div>
  </div>

  <!-- ---------- BGMç”¨ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¿ã‚° ---------- -->
  <audio id="fieldBGM" loop preload="auto">
    <source src="./kouyawoiku.mp3" type="audio/mpeg">
  </audio>
  <audio id="battleBGM" loop preload="auto">
    <source src="./jypdance.mp3" type="audio/mpeg">
  </audio>
  <!-- ã‚¯ã‚¤ã‚ºBGMï¼ˆåŒã˜jypdance.mp3ã‚’ä½¿ç”¨ï¼‰ -->
  <audio id="quizBGM" loop preload="auto">
    <source src="./jypdance.mp3" type="audio/mpeg">
  </audio>
  
  <!-- DQ downç”¨ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¿ã‚° -->
  <audio id="dqDownAudio" preload="auto">
    <source src="./DQ down long.mp3" type="audio/mpeg">
  </audio>

  <!-- ---------- Google API ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ---------- -->
  <script async defer src="https://apis.google.com/js/api.js" 
          onload="gapiLoaded()" 
          onerror="console.error('âŒ Google APIã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');"></script>

  <!-- ========= ä»¥ä¸‹ã€ãƒ¡ã‚¤ãƒ³ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ========= -->
  <script>
    /* ========= ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ========= */
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyUcopm6q6lU0eFyzP9DtukTZ5bkNUXYT_JsFRn0I1L1dv4d9VewWRKlVpzmnkXUx0D4w/exec";
    let playerData = { name: "", level: 1, exp: 0, g: 0 };

    document.getElementById("loginButton").addEventListener("click", function () {
      const enteredName = document.getElementById("playerNameInput").value.trim();
      if (enteredName === "") {
        alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
        return;
      }
      fetch(GAS_URL + "?name=" + encodeURIComponent(enteredName), { method: "GET" })
        .then(response => response.json())
        .then(data => {
          console.log("ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:", data);
          playerData.name = enteredName;
          playerData.level = parseInt(data.level, 10);
          playerData.exp = parseInt(data.exp, 10);
          playerData.g = parseInt(data.g, 10);
          console.log("å–å¾—ã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿:", playerData);
          document.getElementById("loginScreen").style.display = "none";
          document.getElementById("titleScreen").style.display = "flex";
        })
        .catch(error => console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error));
    });

    /* ========= ã‚²ãƒ¼ãƒ ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ========= */
    let quizData = [];
    let monsterData = [];
    let currentMonsters = [];
    let correctCount = 0;
    let missCount = 0;
    let isBattleBGMPlaying = false;
    const MAX_CORRECT = 4;
    const MAX_MISS = 4;
    
    /* ======= Google Sheets & ãƒ‡ãƒ¼ã‚¿è¨­å®š ======= */
    const API_KEY = "AIzaSyBszPu-BQ2_Aq9C3lhAiW--kyenM5vQsjs";
    const QUIZ_SHEET_ID = "1GyKDfVQCNrBlkxjsrQDv_ouIio9yjO3mVQy6Ds5uQzg";
    const MONSTER_SHEET_ID = "1t08cjUMrug0nvIpredcxjuoxejDRazqqzLTqjVraJhw";
    const SHEET_NAME_QUIZ = "sheet1";
    const SHEET_NAME_MONSTER = "sheet1";

    async function loadQuizData() {
      try {
        const resp = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: QUIZ_SHEET_ID,
          range: `${SHEET_NAME_QUIZ}!A2:K1000`
        });
        quizData = resp.result.values.map(row => ({
          question: row[1] || "",
          imageUrl: row[2] || "",
          choices: [row[3], row[4], row[5], row[6]],
          correct: parseInt(row[7] || "1", 10),
          explanation: row[9] || ""
        }));
        console.log("Quiz Data:", quizData);
      } catch (err) {
        console.error("Quiz Data Error:", err);
      }
    }
    async function loadMonsterData() {
      try {
        const resp = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: MONSTER_SHEET_ID,
          range: `${SHEET_NAME_MONSTER}!A2:C1000`
        });
        monsterData = resp.result.values.map(row => ({
          id: row[0] || "",
          name: row[1] || "",
          url: row[2] || ""
        }));
        console.log("Monster Data:", monsterData);
      } catch (err) {
        console.error("Monster Data Error:", err);
      }
    }
    function getRandomQuiz() {
      if (!quizData || quizData.length === 0) return null;
      const idx = Math.floor(Math.random() * quizData.length);
      return quizData[idx];
    }
    function getRandomMonsters() {
      if (monsterData.length < 4) {
        console.warn("Not enough monsters");
        return [];
      }
      const shuffled = [...monsterData].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, 4);
    }
    function initHearts() {
      const heartsContainer = document.getElementById("hearts-container");
      heartsContainer.innerHTML = "";
      for (let i = 0; i < 4; i++) {
        const heart = document.createElement("span");
        heart.className = "heart";
        heart.textContent = "â™¡";
        heartsContainer.appendChild(heart);
      }
    }
    function shakeAndRemoveHeart() {
      const heartsContainer = document.getElementById("hearts-container");
      if (heartsContainer.children.length > 0) {
        const firstHeart = heartsContainer.children[0];
        firstHeart.classList.add("shake");
        setTimeout(() => {
          if (heartsContainer.contains(firstHeart)) {
            heartsContainer.removeChild(firstHeart);
          }
        }, 500);
      }
    }
    /* ========= æˆ¦é—˜é–¢é€£ ========= */
    function startEncounter() {
      inBattle = true;
      stopFieldBGM();
      stopQuizBGM();  
      lastEncounterSteps = player.steps;
      encounterThreshold = getRandomEncounterThreshold();

      const overlay = document.getElementById("transition-overlay");
      const circle = document.getElementById("transition-circle");
      overlay.style.display = "block";

      requestAnimationFrame(() => {
        circle.classList.add("active");
      });

      setTimeout(() => {
        document.getElementById("gameArea").style.display = "none";
        document.getElementById("battle-screen").style.display = "block";
        overlay.style.display = "none";
        circle.classList.remove("active");

        if (isBgmPlaying) {
          playBattleBGM();
        }
        // ã‚¯ã‚¤ã‚ºé–‹å§‹æ™‚ã«ä¸€åº¦ã ã‘ã‚¯ã‚¤ã‚ºBGMã‚’å†ç”Ÿ
        playQuizBGM();
        startBattle();
      }, 800);
    }
    function showMonsters(monsters) {
      console.log("ğŸ“¢ ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’è¡¨ç¤º:", monsters);
      const container = document.getElementById("enemy-container");
      container.innerHTML = "";
      if (!monsters || monsters.length === 0) {
        console.error("â›” ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
        return;
      }
      monsters.forEach(monster => {
        const img = document.createElement("img");
        img.className = "monster";
        img.src = monster.url;
        img.alt = monster.name;
        container.appendChild(img);
      });
      console.log("âœ… ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼è¡¨ç¤ºå®Œäº†");
    }
    function startBattle() {
      correctCount = 0;
      missCount = 0;
      document.getElementById("quiz-image").style.display = "none";
      document.getElementById("choice-area").innerHTML = "";
      document.getElementById("zaorikuButton").style.display = "none";
      initHearts();
      currentMonsters = getRandomMonsters();
      showMonsters(currentMonsters);
      const topTextBox = document.getElementById("top-text-box");
      topTextBox.textContent = "mamãŒã‚ã‚‰ã‚ã‚ŒãŸï¼";
      setTimeout(() => { topTextBox.textContent = ""; }, 2000);
      setTimeout(() => { topTextBox.textContent = "mamã®å¾©ç¿’æ”»æ’ƒï¼"; }, 3000);
      setTimeout(() => {
        topTextBox.textContent = "ã‚¯ã‚¤ã‚ºé–‹å§‹ï¼";
        showQuiz();
      }, 5000);
    }
    function showQuiz() {
      const quiz = getRandomQuiz();
      const topTextBox = document.getElementById("top-text-box");
      if (!quiz) {
        topTextBox.textContent = "ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“";
        return;
      }
      topTextBox.textContent = quiz.question;
      const quizImage = document.getElementById("quiz-image");
      quizImage.src = quiz.imageUrl;
      quizImage.style.display = quiz.imageUrl ? "block" : "none";
      const choiceArea = document.getElementById("choice-area");
      choiceArea.innerHTML = "";
      quiz.choices.forEach((choice, index) => {
        let btn = document.createElement("button");
        btn.className = "choice-button";
        btn.textContent = choice;
        btn.onclick = () => handleAnswer(index + 1, quiz);
        choiceArea.appendChild(btn);
      });
      // â€» ã“ã“ã§ã¯å†åº¦ playQuizBGM() ã¯å‘¼ã°ãšã€ã‚¯ã‚¤ã‚ºé–‹å§‹æ™‚ã«1åº¦ã ã‘å†ç”Ÿæ¸ˆã¿ã¨ã™ã‚‹
      // æ¬¡ã®ã‚¯ã‚¤ã‚ºã¯ handleAnswer() å†…ã§ showQuiz() ã® setTimeout ã«ã‚ˆã‚Šå‘¼ã³å‡ºã•ã‚Œã‚‹
      setTimeout(() => { showQuiz(); }, 3000);
    }
    function handleAnswer(selected, quiz) {
      const topTextBox = document.getElementById("top-text-box");
      if (selected === quiz.correct) {
        correctCount++;
        topTextBox.textContent = "âœ… æ­£è§£ï¼ " + quiz.explanation;
        shakeAndRemoveMonster();
      } else {
        missCount++;
        topTextBox.textContent = "âŒ ä¸æ­£è§£ï¼ " + quiz.explanation;
        shakeAndRemoveHeart();
      }
      if (correctCount >= MAX_CORRECT) {
        setTimeout(() => {
          topTextBox.textContent = "mamã¯å®‰å¿ƒã—ã¦å»ã£ã¦ã„ã£ãŸï¼";
          stopQuizBGM();
          endBattle();
        }, 3000);
        return;
      }
      if (missCount >= MAX_MISS) {
        console.log("ğŸ›‘ ã‚¯ã‚¤ã‚ºå¤±æ•—ï¼ã‚¶ã‚ªãƒªã‚¯ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º");
        stopQuizBGM();
        setTimeout(() => {
          document.getElementById("top-text-box").textContent = "mamã¯å¾©ç¿’ã‚’æ±‚ã‚ãŸã€‚";
          stopQuizBGM();
          stopBattleBGM();
          if (isBgmPlaying) {
            const dqAudio = document.getElementById("dqDownAudio");
            dqAudio.currentTime = 0;
            dqAudio.play().catch(err => console.warn("DQ Down Audio play error:", err));
          } else {
            console.log("ğŸ”‡ BGMã‚ªãƒ•ãªã®ã§DQãƒ€ã‚¦ãƒ³éŸ³ã¯å†ç”Ÿã—ã¾ã›ã‚“");
          }
          document.getElementById("zaorikuButton").style.display = "inline-block";
        }, 1500);
        return;
      }
      setTimeout(() => { showQuiz(); }, 3000);
    }
    function shakeAndRemoveMonster() {
      const container = document.getElementById("enemy-container");
      if (container.children.length > 0) {
        const firstMonster = container.children[0];
        firstMonster.classList.add("shake");
        setTimeout(() => {
          if (container.contains(firstMonster)) {
            container.removeChild(firstMonster);
          }
        }, 500);
      }
    }
    function onZaoriku() {
      const dqAudio = document.getElementById("dqDownAudio");
      if (!isBgmPlaying) {
        console.log("ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆãªã®ã§DQãƒ€ã‚¦ãƒ³éŸ³ã‚’æµã—ã¾ã›ã‚“");
      } else {
        dqAudio.pause();
        dqAudio.currentTime = 0;
        dqAudio.play().catch(err => console.warn("DQ Down Audio play error:", err));
      }
      document.getElementById("top-text-box").textContent = "ã‚¶ã‚ªãƒªã‚¯ãŒå”±ãˆã‚‰ã‚ŒãŸï¼";
      setTimeout(() => { endBattle(); }, 1000);
    }
    function endBattle() {
      stopBattleBGM();
      stopQuizBGM();
      document.getElementById("battle-screen").style.display = "none";
      document.getElementById("gameArea").style.display = "block";
      inBattle = false;
      setTimeout(() => {
        if (isBgmPlaying) {
          playFieldBGM();
        }
      }, 1000);
    }
  </script>
</body>
</html>
