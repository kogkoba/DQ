<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <!-- モバイル対応のためのビューポート設定 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ドラクエ風クイズRPG 統合サンプル</title>



<style> /* ここにCSSをまとめる（重複しないよう注意） */
   
/* ---------- 共通設定 ---------- */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: sans-serif;
      background-color: #222;
      color: #fff;
    }
    /* ---------- タイトル画面 ---------- */
    #titleScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      background: black;
    }
    #startButton {
      font-size: 24px;
      padding: 10px 20px;
      cursor: pointer;
      border: 2px solid #fff;
      background: #444;
      color: #fff;
      border-radius: 5px;
    }
    /* ---------- ゲーム画面全体 ---------- */
    #gameContainer {
      display: none;
      width: 100%;
      height: 100%;
    }
    /* ---------- ステータス表示 ---------- */
    #status {
      padding: 10px;
      text-align: center;
      font-size: 18px;
      background-color: #111;
    }
    
    <!-- ---------- フィールド画面 ---------- -->
    <div id="gameArea">
      <img id="player" src="https://lh3.googleusercontent.com/d/1peHOi70oOmL8c9v3OQydE5N-9R0PB6vh" alt="hero">
      <div id="dpad">
        <div class="dpad-button up" onclick="movePlayer(0, -STEP)"></div>
        <div class="dpad-button left" onclick="movePlayer(-STEP, 0)"></div>
        <div class="dpad-button center"></div>
        <div class="dpad-button right" onclick="movePlayer(STEP, 0)"></div>
        <div class="dpad-button down" onclick="movePlayer(0, STEP)"></div>
      </div>
    /* 勇者画像 */
    #player {
      position: absolute;
      width: 30px;
      height: auto;
    }
    /* ---------- D-Pad ---------- */
    #dpad {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 150px;
      height: 150px;
      display: grid;
      grid-template-areas:
        ".    up    ."
        "left center right"
        ".    down  .";
      grid-gap: 10px;
    }
    .dpad-button {
      width: 50px;
      height: 50px;
      background: rgba(0,0,0,0.3);
      border: 2px solid #fff;
      border-radius: 5px;
      cursor: pointer;
      touch-action: none;
      user-select: none;
    }
    .up    { grid-area: up; }
    .down  { grid-area: down; }
    .left  { grid-area: left; }
    .right { grid-area: right; }
    .center{ grid-area: center; }
    /* ---------- 戦闘画面 ---------- */
    #battle-screen {
      display: none;
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: black;
      padding: 10px;
      text-align: center;
      z-index: 100;
    }
    #top-text-box {
      border: 2px solid white;
      padding: 5px;
      margin-bottom: 5px;
      min-height: 40px;
      font-size: 16px;
    }
    /* 敵表示 */
    #enemy-container {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-bottom: 5px;
    }
    .monster {
      width: 50px;
      height: 50px;
      object-fit: contain;
    }
    /* クイズ画像 */
    #quiz-image {
      display: none;
      width: 150px;
      height: 150px;
      margin: 5px auto;
    }
    /* 選択肢 */
    .choice-button {
      display: block;
      margin: 5px auto;
      padding: 5px;
      width: 150px;
      font-size: 16px;
    }
    /* ハート表示用コンテナ：戦闘画面下部中央に固定 */
    #hearts-container {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
    }
    .heart {
      font-size: 24px;
      color: red;
    }
    /* 解説は不要なので非表示 */
    #explanation {
      display: none;
    }
    #zaorikuButton {
      display: none;
      font-size: 18px;
      padding: 5px 10px;
      margin-top: 10px;
      cursor: pointer;
    }
    /* ---------- 円拡大演出用オーバーレイ ---------- */
    #transition-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 200;
      display: none;
      pointer-events: none;
    }
    #transition-circle {
      position: absolute;
      width: 200vmax;
      height: 200vmax;
      background: black;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      transition: transform 0.8s ease-out;
    }
    #transition-circle.active {
      transform: translate(-50%, -50%) scale(1);
    }
    /* ---------- シェイクアニメーション ---------- */
    @keyframes shake {
      0% { transform: translate(0, 0); }
      20% { transform: translate(-5px, 0); }
      40% { transform: translate(5px, 0); }
      60% { transform: translate(-5px, 0); }
      80% { transform: translate(5px, 0); }
      100% { transform: translate(0, 0); }
    }
    .shake {
      animation: shake 0.5s;
    }
    /* ---------- レスポンシブ調整 ---------- */
    @media (max-width: 600px) {
      #status { font-size: 16px; padding: 10px; }
      #top-text-box { font-size: 14px; padding: 5px; }
      .choice-button { width: 120px; font-size: 14px; }
      #player { width: 25px; }
      #dpad {
        width: 120px;
        height: 120px;
        grid-gap: 5px;
      }
      .dpad-button {
        width: 40px;
        height: 40px;
      }
      .heart { font-size: 20px; }
    }

  </style>
</head>
<body>





  <!-- ---------- タイトル画面 ---------- -->
  <div id="titleScreen">
    <h1>ドラクエ風クイズRPG</h1>
    <button id="startButton" onclick="startGame()">▶ ゲームスタート</button>
  </div>

  <!-- ---------- ゲーム画面全体 ---------- -->
  <div id="gameContainer" style="display: none;">
    <!-- ステータス表示（HP、レベル、EXP、Gなど） -->
    <div id="status">
      プレイヤーのHP: <span id="hp">100</span> /
      レベル: <span id="level">1</span> /
      EXP: <span id="exp">0</span> /
      G: <span id="g">0</span>G
    </div>

    <!-- ---------- フィールド画面 ---------- -->
    <div id="gameArea">
      <img id="player" src="..." alt="hero">
      <div id="dpad">
        <div class="dpad-button up"    onclick="movePlayer(0, -STEP)"></div>
        <div class="dpad-button left"  onclick="movePlayer(-STEP, 0)"></div>
        <div class="dpad-button center"></div>
        <div class="dpad-button right" onclick="movePlayer(STEP, 0)"></div>
        <div class="dpad-button down"  onclick="movePlayer(0, STEP)"></div>
      </div>
      <!-- 戦闘に切り替わるときの円演出 -->
      <div id="transition-overlay">
        <div id="transition-circle"></div>
      </div>
    </div>

    <!-- ---------- 戦闘画面 ---------- -->
    <div id="battle-screen" style="display: none;">
      <div id="top-text-box">mamがあらわれた！</div>
      <div id="enemy-container"></div>
      <img id="quiz-image" src="">
      <div id="choice-area"></div>
      <div id="hearts-container"></div>
      <button id="zaorikuButton" onclick="onZaoriku()">ザオリク</button>
    </div>
  </div>

  <!-- ---------- BGM用オーディオ ---------- -->
  <audio id="fieldBGM" loop preload="auto">
    <source src="./kouyawoiku.mp3" type="audio/mpeg">
  </audio>
  <audio id="battleBGM" loop preload="auto">
    <source src="./gypsydance.mp3" type="audio/mpeg">
  </audio>
  <audio id="dqDownAudio" preload="auto">
    <source src="./DQ down long.mp3" type="audio/mpeg">
  </audio>



  <!-- ---------- Google API のスクリプト ---------- -->
  <script
    async defer
    src="https://apis.google.com/js/api.js"
    onload="gapiLoaded()"
    onerror="console.error('❌ Google APIの読み込みに失敗しました');">
  </script>

  <!-- ---------- メインスクリプト（まとめて1つ） ---------- -->
  <script>







    /* ===============================
     * ここからJavaScriptを一つに整理
     * =============================== */

    // --------------------------------
    // 定数・グローバル変数
    // --------------------------------
    const STEP = 20;
    const API_KEY = "AIzaSyBszPu-BQ2_Aq9C3lhAiW--kyenM5vQsjs";
    const QUIZ_SHEET_ID = "1GyKDfVQCNrBlkxjsrQDv_ouIio9yjO3mVQy6Ds5uQzg";
    const MONSTER_SHEET_ID = "1t08cjUMrug0nvIpredcxjuoxejDRazqqzLTqjVraJhw";
    const SHEET_NAME_QUIZ = "sheet1";
    const SHEET_NAME_MONSTER = "sheet1";

    // プレイヤー情報をまとめて管理する
       let player = { x: 0, y: 0, hp: 100, level: 1, steps: 0 };
       let inBattle = false;
       let correctCount = 0;
       let missCount = 0;
       const MAX_CORRECT = 4;
       const MAX_MISS = 4;
       let quizData = [];
       let monsterData = [];





    // --------------------------------
    // Google API関連
    // --------------------------------
   // ========== Google API 初期化 ==========
    function gapiLoaded() {
      console.log("✅ gapiLoaded");
      gapi.load("client", initClient);
    }
    async function initClient() {
      try {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
        });
        console.log("✅ GAPI Initialized");
        await loadQuizData();
        await loadMonsterData();
        console.log("✅ Data Loaded");
      } catch (err) {
        console.error("⛔ GAPI Init Error:", err);
      }
    }
    // ========== クイズデータ取得 ==========
    async function loadQuizData() {
      try {
        const resp = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: QUIZ_SHEET_ID,
          range: `${SHEET_NAME_QUIZ}!A2:K1000`
        });
        quizData = resp.result.values.map(row => ({
          question: row[1] || "",
          imageUrl: row[2] || "",
          choices: [row[3], row[4], row[5], row[6]],
          correct: parseInt(row[7] || "1", 10),
          explanation: row[9] || ""  // J列から解説を取得（index 9）
        }));
        console.log("Quiz Data:", quizData);
      } catch (err) {
        console.error("Quiz Data Error:", err);
      }
    }

     // ========== クイズデータ取得 ==========
    async function loadQuizData() {
      try {
        const resp = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: QUIZ_SHEET_ID,
          range: `${SHEET_NAME_QUIZ}!A2:K1000`
        });
        quizData = resp.result.values.map(row => ({
          question: row[1] || "",
          imageUrl: row[2] || "",
          choices: [row[3], row[4], row[5], row[6]],
          correct: parseInt(row[7] || "1", 10),
          explanation: row[10] || ""
        }));
        console.log("Quiz Data:", quizData);
      } catch (err) {
        console.error("Quiz Data Error:", err);
      }
    }




     // ========== モンスターデータ取得 ==========　
    async function loadMonsterData() {
      try {
        const resp = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: MONSTER_SHEET_ID,
          range: `${SHEET_NAME_MONSTER}!A2:C1000`
        });
        monsterData = resp.result.values.map(row => ({
          id: row[0] || "",
          name: row[1] || "",
          url: row[2] || ""
        }));
        console.log("Monster Data:", monsterData);
      } catch (err) {
        console.error("Monster Data Error:", err);
      }
    }




     // ========== タイトルからゲーム開始 ==========
    function startGame() {
      document.getElementById("titleScreen").style.display = "none";
      document.getElementById("gameContainer").style.display = "block";
      initGame();
      playFieldBGM();
    }


    function initGame() {
      // プレイヤーの初期位置を画面中央にする
      const ga = document.getElementById("gameArea");
      player.x = ga.clientWidth / 2;
      player.y = ga.clientHeight / 2;
      updatePlayerPosition();
      updateStatus();
    }

    // --------------------------------
    // ステータス表示更新
    // --------------------------------
    function updateStatus() {
      document.getElementById("hp").textContent   = player.hp;
      document.getElementById("level").textContent= player.level;
      document.getElementById("exp").textContent  = player.exp;
      document.getElementById("g").textContent    = player.g;
    }

    // --------------------------------
    // フィールド移動関連
    // --------------------------------
    const playerImages = [
      "立ち姿の画像URL",
      "右足前の画像URL",
      "左足前の画像URL"
    ];
    let currentImageIndex = 0;
    let facingRight = true;

    function movePlayer(dx, dy) {
      if (inBattle) return; // 戦闘中は移動できない
      if (dx < 0) facingRight = false;
      if (dx > 0) facingRight = true;

      // 歩行アニメ
      currentImageIndex = (currentImageIndex + 1) % playerImages.length;
      document.getElementById("player").src = playerImages[currentImageIndex];

      // 座標更新
      player.x += dx;
      player.y += dy;
      // 画面外に出ないようにクリップ
      // ・・・

      updatePlayerPosition();

      // 歩数カウント
      player.steps++;
      console.log("歩数:", player.steps);

      // ここで一定歩数ごとにエンカウントなど
      if (player.steps % 10 === 0) {
        startEncounter();
      }
    }

    function updatePlayerPosition() {
      const el = document.getElementById("player");
      el.style.left = player.x + "px";
      el.style.top  = player.y + "px";
      el.style.transform =
        "translate(-50%, -50%) " + (facingRight ? "scaleX(1)" : "scaleX(-1)");
    }

    // --------------------------------
    // 戦闘処理
    // --------------------------------
    function startEncounter() {
      inBattle = true;
      stopFieldBGM();
      // 円演出 → 戦闘画面へ切り替え
      // ・・・

      setTimeout(() => {
        document.getElementById("gameArea").style.display = "none";
        document.getElementById("battle-screen").style.display = "block";
        playBattleBGM();
        startBattle();
      }, 800);
    }

    function startBattle() {
      correctCount = 0;
      missCount = 0;
      // ハート初期化
      initHearts();

      // モンスター選択 → 表示
      // ・・・

      document.getElementById("top-text-box").textContent = "mamがあらわれた！";
      setTimeout(() => {
        // クイズ開始
        showQuiz();
      }, 2000);
    }

    function showQuiz() {
      // ランダムにクイズを取得して問題文や画像、選択肢をセット
      // ・・・
    }

    function handleAnswer(selected, quiz) {
      // 正誤判定 → カウント加算
      // ・・・
      if (correctCount >= MAX_CORRECT) {
        // 勝利
        endBattle();
        return;
      }
      if (missCount >= MAX_MISS) {
        // ザオリク要求
        // ・・・
        return;
      }
      // 次の問題
      setTimeout(showQuiz, 1000);
    }

    function onZaoriku() {
      // DQダウン音停止
      // ・・・
      setTimeout(endBattle, 1000);
    }

    function endBattle() {
      stopBattleBGM();
      document.getElementById("battle-screen").style.display = "none";
      document.getElementById("gameArea").style.display = "block";
      inBattle = false;
      setTimeout(playFieldBGM, 1000);
    }

    // --------------------------------
    // ハートやモンスター表示
    // --------------------------------
    function initHearts() {
      const hc = document.getElementById("hearts-container");
      hc.innerHTML = "";
      for (let i = 0; i < 4; i++) {
        const heart = document.createElement("span");
        heart.className = "heart";
        heart.textContent = "♡";
        hc.appendChild(heart);
      }
    }

    // --------------------------------
    // BGM関連
    // --------------------------------
    const fieldBGM = document.getElementById("fieldBGM");
    const battleBGM = document.getElementById("battleBGM");
    function playFieldBGM() {
      fieldBGM.currentTime = 0;
      fieldBGM.play().catch(err => console.warn(err));
    }
    function stopFieldBGM() {
      fieldBGM.pause();
    }
    function playBattleBGM() {
      battleBGM.currentTime = 0;
      battleBGM.play().catch(err => console.warn(err));
    }
    function stopBattleBGM() {
      battleBGM.pause();
    }

  </script>
</body>
</html>
