<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>モンスター4体表示 & シェイク演出</title>
  <style>
    /* 画面全体やフィールドのスタイルは省略（既存のコードに合わせてください） */
    /* 戦闘画面 */
    #battle-screen {
      display: none;
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: black;
      padding: 20px;
      text-align: center;
      z-index: 100;
    }
    /* 上部テキストボックス */
    #top-text-box {
      border: 2px solid white;
      padding: 10px;
      margin-bottom: 10px;
      color: white;
    }
    /* モンスターを並べるコンテナ */
    #enemy-container {
      display: flex;
      justify-content: center; /* 中央寄せ */
      gap: 10px;              /* 隙間 */
      margin-bottom: 10px;    /* 下マージン */
    }
    .monster {
      width: 60px;  /* 小さく表示 */
      height: 60px;
      object-fit: contain;
    }
    /* クイズ画像（C列の画像）を表示する要素 */
    #quiz-image {
      display: none;
      width: 200px;
      height: 200px;
      margin: 10px auto;
    }
    /* 選択肢ボタン */
    .choice-button {
      display: block;
      margin: 10px auto;
      padding: 10px;
      width: 200px;
      font-size: 18px;
    }
    /* 解説表示 */
    #explanation {
      display: none;
      color: yellow;
      margin: 10px;
    }
    /* ザオリクボタン（4回ミス時に表示） */
    #zaorikuButton {
      display: none;
      font-size: 20px;
      padding: 10px 20px;
      margin-top: 20px;
      cursor: pointer;
    }

    /* シェイクアニメーション */
    @keyframes shake {
      0%   { transform: translate(0, 0); }
      20%  { transform: translate(-5px, 0); }
      40%  { transform: translate(5px, 0); }
      60%  { transform: translate(-5px, 0); }
      80%  { transform: translate(5px, 0); }
      100% { transform: translate(0, 0); }
    }
    .shake {
      animation: shake 0.5s;
    }
  </style>
</head>
<body>
  <!-- ... フィールド画面など既存の構造は省略 ... -->

  <!-- 戦闘画面 -->
  <div id="battle-screen">
    <div id="top-text-box">モンスターがあらわれた！</div>
    <div id="enemy-container"></div>  <!-- モンスター4体を並べる場所 -->
    <img id="quiz-image" src="">
    <div id="choice-area"></div>
    <p id="explanation"></p>
    <button id="zaorikuButton" onclick="onZaoriku()">ザオリク</button>
  </div>

  <script>
    /* スプレッドシートの情報 */
    const MONSTER_SHEET_ID = "1t08cjUMrug0nvIpredcxjuoxejDRazqqzLTqjVraJhw";
    const SHEET_NAME_MONSTER = "シート1"; // 実際のシート名に合わせてください

    /* モンスター配列を格納する変数 */
    let monsterData = [];    // 全モンスターのリスト
    let currentMonsters = []; // 今回選ばれた4体

    /* クイズ正解・ミスのカウント */
    let correctCount = 0;
    let missCount = 0;

    /* 例: 4回正解 or 4回ミスでクイズ終了 */
    const MAX_CORRECT = 4;
    const MAX_MISS = 4;

    /* Google Sheets からモンスターを読み込み (A列=ID, B列=名前, C列=URL) */
    async function loadMonsterData() {
      try {
        const resp = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: MONSTER_SHEET_ID,
          range: `${SHEET_NAME_MONSTER}!A2:C1000`
        });
        console.log("モンスターデータ取得:", resp.result.values);

        monsterData = resp.result.values.map(row => ({
          id: row[0] || "",
          name: row[1] || "",
          url: row[2] || ""
        }));
        console.log("monsterData:", monsterData);
      } catch (err) {
        console.error("モンスターデータ取得エラー:", err);
      }
    }

    /* 4体のモンスターをランダムに選ぶ関数 */
    function getRandomMonsters() {
      if (monsterData.length < 4) {
        console.warn("モンスター数が4未満です");
        return [];
      }
      // シャッフルして先頭4つを取る
      const shuffled = [...monsterData].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, 4);
    }

    /* モンスターを画面に表示する */
    function showMonsters(monsters) {
      const container = document.getElementById("enemy-container");
      container.innerHTML = ""; // 一旦クリア

      monsters.forEach(mon => {
        const img = document.createElement("img");
        img.className = "monster";
        img.src = mon.url;
        img.alt = mon.name;
        container.appendChild(img);
      });
    }

    /* クイズが始まる時に呼ばれる想定の関数 */
    function startBattle() {
      // カウント初期化
      correctCount = 0;
      missCount = 0;
      document.getElementById("explanation").style.display = "none";
      document.getElementById("explanation").textContent = "";
      document.getElementById("zaorikuButton").style.display = "none";

      // モンスター4体を選んで表示
      currentMonsters = getRandomMonsters();
      showMonsters(currentMonsters);

      // テキストをリセット
      document.getElementById("top-text-box").textContent = "モンスターがあらわれた！";
      // クイズ1問目を出題 (あるいは showQuiz() を呼ぶ)
      showQuiz();
    }

    /* クイズ表示 */
    function showQuiz() {
      // ここは既存のクイズ取得ロジックに合わせて書き換えてください
      // 例: ランダムで1問取得
      const quiz = getRandomQuiz(); // 既存の実装を想定
      if (!quiz) {
        document.getElementById("top-text-box").textContent = "クイズデータがありません";
        return;
      }

      // 問題文を表示
      document.getElementById("top-text-box").textContent = quiz.question;
      // 画像
      let quizImage = document.getElementById("quiz-image");
      quizImage.src = quiz.imageUrl;
      quizImage.style.display = quiz.imageUrl ? "block" : "none";

      // 選択肢ボタン
      let choiceArea = document.getElementById("choice-area");
      choiceArea.innerHTML = "";
      quiz.choices.forEach((choice, index) => {
        let btn = document.createElement("button");
        btn.className = "choice-button";
        btn.textContent = `▶ ${choice}`;
        btn.onclick = () => handleAnswer(index + 1, quiz);
        choiceArea.appendChild(btn);
      });
    }

    /* 回答処理 */
    function handleAnswer(selected, quiz) {
      // 不要なら既存の explanation 表示を消す
      document.getElementById("explanation").style.display = "none";
      document.getElementById("explanation").textContent = "";

      if (selected === quiz.correct) {
        correctCount++;
        // 左端のモンスターをシェイク→削除
        shakeAndRemoveMonster();

        // アラート or メッセージ
        alert("正解！");

      } else {
        missCount++;
        // HPを減らすなどの処理があれば行う
        alert("不正解...");
        // 解説表示
        document.getElementById("explanation").style.display = "block";
        document.getElementById("explanation").textContent = quiz.explanation;
      }

      // 終了判定
      if (correctCount >= MAX_CORRECT) {
        alert("4回正解！モンスターを倒した！");
        endBattle(); // フィールドに戻る
        return;
      }
      if (missCount >= MAX_MISS) {
        alert("4回ミス...。");
        // ザオリクボタンを表示
        document.getElementById("zaorikuButton").style.display = "inline-block";
        return;
      }

      // 次の問題を表示
      showQuiz();
    }

    /* 左端のモンスターをシェイクさせて消す */
    function shakeAndRemoveMonster() {
      const container = document.getElementById("enemy-container");
      if (container.children.length > 0) {
        // 最初の子要素(左端)
        const firstMonster = container.children[0];
        // シェイククラスを付与
        firstMonster.classList.add("shake");

        // 0.5秒後(アニメーション終了後)に削除
        setTimeout(() => {
          if (container.contains(firstMonster)) {
            container.removeChild(firstMonster);
          }
        }, 500);
      }
    }

    /* ザオリクボタンを押した時の処理 */
    function onZaoriku() {
      alert("ザオリクが唱えられた！ しかし何も起こらなかった...");
      // 必要に応じて、ミス回数をリセットするとか、ゲームオーバー解除するとかの処理を実装
      // ここではサンプルとして戦闘終了扱いにします
      endBattle();
    }

    /* 戦闘終了 → フィールドに戻る処理 */
    function endBattle() {
      // 戦闘画面を非表示、フィールド画面を再表示するなど
      document.getElementById("battle-screen").style.display = "none";
      document.getElementById("gameArea").style.display = "block";

      // BGM切り替えなど必要ならここで
      // ...
    }

    /* 例: startEncounter() で呼ばれる */
    async function startEncounter() {
      // まずはモンスターデータを読み込み (まだ読み込んでいなければ)
      if (monsterData.length === 0) {
        await loadMonsterData();
      }
      // 戦闘画面を表示
      document.getElementById("battle-screen").style.display = "block";
      document.getElementById("gameArea").style.display = "none";

      // ここで4体モンスター表示+クイズ開始
      startBattle();
    }

    /* 既存のGoogle APIロードやゲーム初期化は省略 */
  </script>
</body>
</html>
