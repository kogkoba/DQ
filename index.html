<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ‰ãƒ©ã‚¯ã‚¨é¢¨ã‚¯ã‚¤ã‚ºRPG çµ±åˆã‚µãƒ³ãƒ—ãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ==================== CSS ==================== -->
  <style>
    /* ---------- å…±é€šè¨­å®š ---------- */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: sans-serif;
      background-color: #222;
      color: #fff;
    }
    /* ---------- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ---------- */
    #loginScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      background: black;
    }
    #loginScreen input, #loginScreen button {
      font-size: 18px;
      padding: 5px;
      margin: 10px;
    }
    /* ---------- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ ---------- */
    #titleScreen {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      background: black;
    }
    #startButton {
      font-size: 24px;
      padding: 10px 20px;
      cursor: pointer;
      border: 2px solid #fff;
      background: #444;
      color: #fff;
      border-radius: 5px;
    }
    /* ---------- ã‚²ãƒ¼ãƒ ç”»é¢å…¨ä½“ ---------- */
    #gameContainer {
      display: none;
      width: 100%;
      height: 100%;
    }
    /* ---------- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º ---------- */
    #status {
      padding: 10px;
      text-align: center;
      font-size: 18px;
      background-color: #111;
    }
    /* ---------- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”»é¢ ---------- */
    #gameArea {
      position: relative;
      width: 100%;
      height: calc(100% - 50px);
      background: url("https://lh3.googleusercontent.com/d/1jDckidA8IqAdhUncYX09kzOQd2IqanYQ") no-repeat center center;
      background-size: cover;
      overflow: hidden;
    }
    #player {
      position: absolute;
      width: 30px;
      height: auto;
    }
    
    /* ---------- D-Pad ---------- */
    #dpad {
      position: absolute;
      bottom: 70px;
      right: 50px;
      width: 150px;
      height: 150px;
      display: grid;
      grid-gap: 10px;
      grid-template-areas:
        ".    up    ."
        "left center right"
        ".    down  .";
    }
    .dpad-button {
      width: 50px;
      height: 50px;
      background: rgba(0,0,0,0.3);
      border: 2px solid #fff;
      border-radius: 5px;
      cursor: pointer;
      touch-action: none;
      user-select: none;
    }
    .up    { grid-area: up; }
    .down  { grid-area: down; }
    .left  { grid-area: left; }
    .right { grid-area: right; }
    .center{ grid-area: center; }
    /* ---------- æˆ¦é—˜ç”»é¢ ---------- */
    #battle-screen {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      padding: 10px;
      text-align: center;
      z-index: 100;
    }
    #top-text-box {
      border: 2px solid white;
      padding: 5px;
      margin-bottom: 5px;
      min-height: 40px;
      font-size: 16px;
    }
    #enemy-container {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-bottom: 5px;
    }
    .monster {
      width: 50px;
      height: 50px;
      object-fit: contain;
    }
    #quiz-image {
      display: none;
      width: 150px;
      height: 150px;
      margin: 5px auto;
    }
    .choice-button {
      display: block;
      margin: 5px auto;
      padding: 5px;
      width: 150px;
      font-size: 16px;
      cursor: pointer;
    }
    .choice-button:disabled {
      opacity: 0.5;
      cursor: default;
    }
/* ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
#hearts-container {
  display: flex;
  justify-content: center; /* ä¸­å¤®é…ç½® */
  gap: 10px;
  margin-top: 20px;
  min-height: 30px; /* ãƒãƒ¼ãƒˆãŒå‹•ã‹ãªã„ã‚ˆã†ã«æœ€ä½ã®é«˜ã•ã‚’å›ºå®š */
}

/* é¸æŠè‚¢ã‚¨ãƒªã‚¢ï¼ˆquiz-areaï¼‰ã®èª¿æ•´ */
#quiz-area {
  display: flex;
  flex-direction: column;
  align-items: center; /* ä¸­å¤®é…ç½® */
}

    #explanation { display: none; }
    #zaorikuButton {
      display: none;
      font-size: 18px;
      padding: 5px 10px;
      margin-top: 10px;
      cursor: pointer;
    }
    /* ---------- å††æ‹¡å¤§æ¼”å‡ºç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ---------- */
    #transition-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 200;
      display: none;
      pointer-events: none;
    }
    #transition-circle {
      position: absolute;
      width: 200vmax;
      height: 200vmax;
      background: black;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      transition: transform 0.8s ease-out;
    }
    #transition-circle.active {
      transform: translate(-50%, -50%) scale(1);
    }
    /* ---------- ã‚·ã‚§ã‚¤ã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ---------- */
    @keyframes shake {
      0% { transform: translate(0, 0); }
      20% { transform: translate(-10px, 0); }
      40% { transform: translate(10px, 0); }
      60% { transform: translate(-10px, 0); }
      80% { transform: translate(10px, 0); }
      100% { transform: translate(0, 0); }
    }
    .shake {
      animation: shake 0.5s;
    }
    /* ---------- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ---------- */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #fff;
      z-index: 300;
      display: none;
    }
    /* ---------- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ ---------- */
    @media (max-width: 600px) {
      #status { font-size: 16px; padding: 10px; }
      #top-text-box { font-size: 14px; padding: 5px; }
      .choice-button { width: 120px; font-size: 14px; }
      #player { width: 25px; }
      #dpad { width: 120px; height: 120px; grid-gap: 5px; }
      .dpad-button { width: 40px; height: 40px; }
      .heart { font-size: 20px; }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="loadingOverlay">Loadingâ€¦</div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <div id="loginScreen">
    <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
    <input type="text" id="playerNameInput" placeholder="åå‰ã‚’å…¥åŠ›">
    <button id="loginButton">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>

  <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
  <div id="titleScreen">
    <h1>ãƒ‰ãƒ©ã‚¯ã‚¨é¢¨ã‚¯ã‚¤ã‚ºRPG</h1>
    <button id="startButton" onclick="startGame()">â–¶ ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>

  <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
  <div id="gameContainer">
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div id="status">
      ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®HP: <span id="hp">50</span> / ãƒ¬ãƒ™ãƒ«: <span id="level">1</span>
      <div id="bgmToggleContainer">
        <button id="bgmToggleButton" onclick="toggleBgm()">ğŸ”‡ BGM OFF</button>
      </div>
    </div>
    
    <!-- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”»é¢ -->
    <div id="gameArea">
      <img id="player" src="https://lh3.googleusercontent.com/d/1peHOi70oOmL8c9v3OQydE5N-9R0PB6vh" alt="hero">
      <div id="dpad">
        <div class="dpad-button up" onclick="movePlayer(0, -STEP)"></div>
        <div class="dpad-button left" onclick="movePlayer(-STEP, 0)"></div>
        <div class="dpad-button center"></div>
        <div class="dpad-button right" onclick="movePlayer(STEP, 0)"></div>
        <div class="dpad-button down" onclick="movePlayer(0, STEP)"></div>
      </div>
      <div id="transition-overlay">
        <div id="transition-circle"></div>
      </div>
    </div>
    
<!-- æˆ¦é—˜ç”»é¢ -->
<div id="battle-screen">
  <div id="top-text-box">mamãŒã‚ã‚‰ã‚ã‚ŒãŸï¼</div>

  <!-- ğŸ”½ ã‚¯ã‚¤ã‚ºç”»é¢ã®HPè¡¨ç¤ºã‚’ã“ã“ã«è¿½åŠ  -->
  <div id="quiz-hp-container">
    HP: <span id="quiz-hp">50</span>
  </div>

  <div id="enemy-container"></div>
  <img id="quiz-image" src="">
  
  <!-- å•é¡Œã¨é¸æŠè‚¢ã‚¨ãƒªã‚¢ -->
  <div id="quiz-area">
    <div id="choice-area"></div>
  </div>

  <!-- ãƒãƒ¼ãƒˆã‚’ã“ã“ã«ç§»å‹•ï¼ˆå•é¡Œã¨ã¯åˆ¥ã«ã™ã‚‹ï¼‰ -->
  <div id="hearts-container"></div>

  <button id="zaorikuButton" onclick="onZaoriku()">ã‚¶ã‚ªãƒªã‚¯</button>
</div>
<!-- HPå›å¾©ãƒœã‚¿ãƒ³ (ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”»é¢) -->
<button id="healButton" onclick="changeHp(10)">ğŸ’– å›å¾©ã™ã‚‹ (+10 HP)</button>

  <!-- BGMç”¨ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¿ã‚° -->
  <audio id="fieldBGM" loop preload="auto">
    <source src="./kouyawoiku.mp3" type="audio/mpeg">
  </audio>
  <audio id="battleBGM" loop preload="auto">
    <source src="./jypdance.mp3" type="audio/mpeg">
  </audio>
  <audio id="quizBGM" loop preload="auto">
    <source src="./jypdance.mp3" type="audio/mpeg">
  </audio>
  <audio id="dqDownAudio" preload="auto">
    <source src="./DQ down long.mp3" type="audio/mpeg">
  </audio>

<script async defer src="https://apis.google.com/js/api.js"></script>
<script>
  function gapiLoaded() {
    console.log("âœ… gapiLoaded");
    gapi.load("client", initClient);
  }

  function initClient() {
    gapi.client.init({
      apiKey: "AIzaSyBszPu-BQ2_Aq9C3lhAiW--kyenM5vQsjs",  // ã“ã“ã‚’æœ‰åŠ¹ãªAPIã‚­ãƒ¼ã«ç½®ãæ›ãˆ
      discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
    }).then(() => {
      console.log("âœ… Google Sheets API åˆæœŸåŒ–æˆåŠŸ");
      loadQuizData();
      loadMonsterData();
    }).catch(err => {
      console.error("â›” Google API åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", err);
    });
  }

  window.onload = gapiLoaded;  // ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†å¾Œã« `gapiLoaded` ã‚’å®Ÿè¡Œ
</script>

 
  <!-- ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    // --- gapièª­ã¿è¾¼ã¿å¾Œã«å‘¼ã°ã‚Œã‚‹ ---
    function gapiLoaded() {
      console.log("âœ… gapiLoaded");
      gapi.load("client", initClient);
    }
async function initClient() {
  try {
    console.log("ğŸ”„ initClient() é–‹å§‹...");
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
    });
    console.log("âœ… GAPI Initialized");
    
    // ã“ã“ã§ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
    await loadQuizData();
    await loadMonsterData();

    console.log("âœ… Data Loaded");
  } catch (err) {
    console.error("â›” GAPI Init Error:", err.message || err);
  }
}

    // --- å®šæ•°ãƒ»ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    const API_KEY = "AIzaSyBszPu-BQ2_Aq9C3lhAiW--kyenM5vQsjs";
    const GAS_PERSONAL_URL = "https://script.google.com/macros/s/AKfycbysoCsP1D4qh_wxWoBns2H2F6UBMmOxARGyo2jv4PhsDfoQkjndge-p-FvNxkD-n-b1/exec";
    const STEP = 20;
    const QUIZ_SHEET_ID = "1GyKDfVQCNrBlkxjsrQDv_ouIio9yjO3mVQy6Ds5uQzg";
    const MONSTER_SHEET_ID = "1t08cjUMrug0nvIpredcxjuoxejDRazqqzLTqjVraJhw";
    const SHEET_NAME_QUIZ = "sheet1";
    const SHEET_NAME_MONSTER = "sheet1";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwr32j-z2AE0AwYbP2JguFxiPZHVJHghjQCgEz1bIT0T2ZxyKKuQx7294jIAtBpa2MnFw/exec";

    let playerData = { name: "", level: 1, exp: 0, g: 0, hp: 50 }; // åˆæœŸHPã‚’50ã«å¤‰æ›´
    let quizData = [];
    let monsterData = [];
    let player = { x: 0, y: 0, hp: 50, level: 1, steps: 0 };
    let facingRight = true;
    let currentImageIndex = 0;
    const playerImages = [
      "https://lh3.googleusercontent.com/d/1peHOi70oOmL8c9v3OQydE5N-9R0PB6vh",
      "https://lh3.googleusercontent.com/d/1iuVZiT6Eh9mp2Ta__Cpm5z28HZ2k0YA0",
      "https://lh3.googleusercontent.com/d/1fCmul9iotoUh4MLa_qzHvaOUDYMvng8C"
    ];
    let inBattle = false;
    let correctCount = 0;
    let missCount = 0;
    const MAX_CORRECT = 4;
    const MAX_MISS = 4;
    let lastEncounterSteps = 0;
    let encounterThreshold = 5;
    // ğŸ”¹ è¿½åŠ : ãƒãƒˆãƒ«é–‹å§‹æ™‚ã®HPã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°
    let battleStartHp = 50;

    // --- BGMé–¢é€£ ---
    let isBgmPlaying = false;
    let isBattleBgmPlaying = false;
    let quizBgm = null;

    // --- ã‚¯ã‚¤ã‚ºï¼†ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿å–å¾— ---
async function loadQuizData() {
  try {
    const resp = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: QUIZ_SHEET_ID,
      range: `sheet1!A2:K1000`
    });
    if (!resp.result.values) {
      console.warn("ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚");
      return;
    }
    quizData = resp.result.values.map(row => ({
      questionId: row[0] || "",
      question: row[1] || "",
      imageUrl: row[2] || "",
      choices: [row[3], row[4], row[5], row[6]],
      correct: parseInt(row[7] || "1", 10),
      explanation: row[9] || ""
    }));
    console.log("âœ… Quiz Data:", quizData);
  } catch (err) {
    console.error("â›” Quiz Data Error:", err);
  }
}

    async function loadMonsterData() {
      try {
        const resp = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: MONSTER_SHEET_ID,
          range: `sheet1!A2:C1000`
        });
        if (!resp.result.values) {
          console.warn("ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚");
          return;
        }
        monsterData = resp.result.values.map(row => ({
          id: row[0] || "",
          name: row[1] || "",
          url: row[2] || ""
        }));
        console.log("Monster Data:", monsterData);
      } catch (err) {
        console.error("Monster Data Error:", err);
      }
    }
    function getRandomQuiz() {
      if (!quizData || quizData.length === 0) return null;
      const idx = Math.floor(Math.random() * quizData.length);
      return quizData[idx];
    }
    function getRandomMonsters() {
      if (monsterData.length < 4) {
        console.warn("Not enough monsters");
        return [];
      }
      const shuffled = [...monsterData].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, 4);
    }

    // --- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ---
    function showLoadingOverlay() {
      const overlay = document.getElementById("loadingOverlay");
      if (overlay) overlay.style.display = "flex";
    }
    function hideLoadingOverlay() {
      const overlay = document.getElementById("loadingOverlay");
      if (overlay) overlay.style.display = "none";
    }

    // --- BGMç®¡ç† ---
    function updateBgmButton() {
      const button = document.getElementById("bgmToggleButton");
      if (!button) return;
      button.textContent = isBgmPlaying ? "ğŸµ BGM ON" : "ğŸ”‡ BGM OFF";
    }
    function toggleBgm() {
      isBgmPlaying = !isBgmPlaying;
      const button = document.getElementById("bgmToggleButton");
      if (isBgmPlaying) {
        button.textContent = "ğŸµ BGM ON";
        playFieldBgm();
      } else {
        button.textContent = "ğŸ”‡ BGM OFF";
        stopFieldBgm();
        stopBattleBgm();
        stopQuizBgm();
      }
      updateBgmButton();
    }
    function playFieldBgm() {
      if (!isBgmPlaying) return;
      const fieldBgm = document.getElementById("fieldBGM");
      fieldBgm.currentTime = 0;
      fieldBgm.play().catch(err => console.warn("ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
    }
    function stopFieldBgm() {
      const fieldBgm = document.getElementById("fieldBGM");
      if (!fieldBgm) return;
      fieldBgm.pause();
      fieldBgm.currentTime = 0;
    }
    function playBattleBgm() {
      if (!isBgmPlaying || isBattleBgmPlaying) return;
      const battleBgm = document.getElementById("battleBGM");
      battleBgm.currentTime = 0;
      battleBgm.play().then(() => { isBattleBgmPlaying = true; })
        .catch(err => console.warn("æˆ¦é—˜BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
    }
    function stopBattleBgm() {
      const battleBgm = document.getElementById("battleBGM");
      if (!battleBgm) return;
      battleBgm.pause();
      battleBgm.currentTime = 0;
      isBattleBgmPlaying = false;
    }
    function playQuizBgm() {
      if (!quizBgm || !isBgmPlaying || !quizBgm.paused) return;
      quizBgm.currentTime = 0;
      quizBgm.play().catch(err => console.warn("ã‚¯ã‚¤ã‚ºBGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
    }
    function stopQuizBgm() {
      if (!quizBgm) return;
      quizBgm.pause();
      quizBgm.currentTime = 0;
      console.log("â¹ ã‚¯ã‚¤ã‚ºBGMåœæ­¢");
    }

function updatePlayerStatusUI() {
  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”»é¢ã®HPã‚’æ›´æ–°
  document.getElementById("level").textContent = playerData.level;
  document.getElementById("hp").textContent = playerData.hp;

// ğŸ¯ HP 0 ã®ã¨ãã«å†æŒ‘æˆ¦ or æ•™ä¼šã®é¸æŠè‚¢ã‚’è¡¨ç¤ºã™ã‚‹
function showGameOverOptions() {
  stopQuizBgm(); // ã‚¯ã‚¤ã‚ºBGMã‚’åœæ­¢
  stopBattleBgm(); // æˆ¦é—˜BGMã‚’åœæ­¢

  const topTextBox = document.getElementById("top-text-box");
  topTextBox.textContent = "ğŸ’€ HPãŒå°½ããŸâ€¦ã©ã†ã™ã‚‹ï¼Ÿ";

  // é¸æŠè‚¢ã®ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
  const choiceArea = document.getElementById("choice-area");
  choiceArea.innerHTML = ""; // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚’æ¶ˆå»


  const churchButton = document.createElement("button");
  churchButton.textContent = "æ•™ä¼šã‹ã‚‰å†é–‹";
  churchButton.className = "choice-button";
  churchButton.onclick = restartFromChurch; // æ•™ä¼šã‹ã‚‰å†é–‹ã™ã‚‹é–¢æ•°ã‚’å®Ÿè¡Œ

  choiceArea.appendChild(retryButton);
  choiceArea.appendChild(churchButton);
}
function retryBattle() {
  const topTextBox = document.getElementById("top-text-box");
  topTextBox.textContent = "å†æŒ‘æˆ¦ã—ã¾ã™ï¼";

  // ğŸ”¹ HPã‚’ãƒãƒˆãƒ«é–‹å§‹æ™‚ã®HPã«æˆ»ã™ï¼ˆç¢ºå®Ÿã«50ä»¥ä¸Šã«ãªã‚‰ãªã„ã‚ˆã†èª¿æ•´ï¼‰
  playerData.hp = Math.min(battleStartHp, 50);  
  updatePlayerStatusUI();
  savePlayerData();

  // ğŸ”¹ ã‚¯ã‚¤ã‚ºã‚’å†ã‚¹ã‚¿ãƒ¼ãƒˆ
  setTimeout(() => {
    startBattleInit();
    showQuiz();
  }, 1000);
}

  // ã‚¯ã‚¤ã‚ºç”»é¢ã®HPã‚’æ›´æ–°
  const quizHpElement = document.getElementById("quiz-hp");
  if (quizHpElement) {
    quizHpElement.textContent = playerData.hp;
  }
}

function savePlayerData() {
  const params = new URLSearchParams();
  params.append("name", playerData.name);
  params.append("level", playerData.level);
  params.append("exp", playerData.exp);
  params.append("g", playerData.g);
  params.append("hp", playerData.hp);

  fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" }, // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
    body: params
  })
  .then(response => response.json()) // JSONã¨ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†
  .then(data => {
    if (data.success) {
      console.log("âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜æˆåŠŸ");
    } else {
      console.error("â›” ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:", data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼");
    }
  })
  .catch(error => {
    console.error("â›” ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼:", error);
  });
}

    function checkLevelUp() {
      while (playerData.exp >= 100 && playerData.level < 100) {
        playerData.exp -= 100;
        playerData.level++;
        playerData.g += 10;
        if (playerData.level === 100) {
          playerData.g += 500;
          playerData.exp = 0;
        }
        console.log(`ğŸ‰ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«: ${playerData.level}`);
      }
    }
    function addExp(amount) {
      playerData.exp += amount;
      checkLevelUp();
      updatePlayerStatusUI();
      savePlayerData();
    }
    
function changeHp(amount) {
  playerData.hp += amount;
  playerData.hp = Math.max(0, Math.min(50, playerData.hp)); // 0ï½50ã®ç¯„å›²ã«åˆ¶é™
  updatePlayerStatusUI();
  savePlayerData();

  if (playerData.hp === 0) {
    showGameOverOptions();
    return;
  }
}


    // --- ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®é–‹å§‹å‡¦ç† ---
    document.addEventListener("DOMContentLoaded", () => {
      console.log("âœ… DOMContentLoaded");
        // ğŸ”½ å›å¾©ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
  document.getElementById("healButton").style.display = "none";

      
      stopFieldBgm();
      stopBattleBgm();
      stopQuizBgm();
      isBgmPlaying = false;
      const bgmButton = document.getElementById("bgmToggleButton");
      if (bgmButton) bgmButton.textContent = "ğŸ”‡ BGM OFF";
      quizBgm = document.getElementById("quizBGM");
      if (quizBgm) quizBgm.loop = true;
      updateBgmButton();

      // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
      document.getElementById("loginButton").addEventListener("click", async () => {
        const enteredName = document.getElementById("playerNameInput").value.trim();
        if (!enteredName) {
          alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
          return;
        }
        try {
          showLoadingOverlay();
          const resp = await fetch(`${GAS_URL}?name=${encodeURIComponent(enteredName)}`);
          if (!resp.ok) throw new Error("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã§ã™");
          const data = await resp.json();
          console.log("ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:", data);

          playerData.name  = enteredName;
          playerData.level = parseInt(data.level, 10);
          playerData.exp   = parseInt(data.exp, 10);
          playerData.g     = parseInt(data.g, 10);
          playerData.hp    = parseInt(data.hp, 10) || 50;

          updatePlayerStatusUI();

          setTimeout(() => {
            hideLoadingOverlay();
            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("titleScreen").style.display = "flex";
          }, 500);
        } catch (err) {
          console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
          hideLoadingOverlay();
          alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        }
      });
    });

    // --- ã‚²ãƒ¼ãƒ é–‹å§‹ ---
    function initGame() {
      const gameArea = document.getElementById("gameArea");
      player.x = window.innerWidth / 2;
      player.y = gameArea.clientHeight / 2;
      updatePlayerPosition();
    }
    function startGame() {
      console.log("ğŸ® startGame() å®Ÿè¡Œï¼");
      document.getElementById("titleScreen").style.display = "none";
      document.getElementById("gameContainer").style.display = "block";
      initGame();
      lastEncounterSteps = player.steps;
      encounterThreshold = getRandomEncounterThreshold();
      console.log("ğŸ² åˆæœŸåŒ–å®Œäº†ï¼");
    }

    // --- ç§»å‹•é–¢é€£ ---
    function updatePlayerPosition() {
      const playerElement = document.getElementById("player");
      playerElement.style.left = player.x + "px";
      playerElement.style.top = player.y + "px";
      playerElement.style.transform = "translate(-50%, -50%) " + (facingRight ? "scaleX(1)" : "scaleX(-1)");
    }
    function movePlayer(dx, dy) {
      if (inBattle) return;
      if (dx < 0) facingRight = false;
      else if (dx > 0) facingRight = true;

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ç”»åƒåˆ‡æ›¿
      currentImageIndex = (currentImageIndex + 1) % playerImages.length;
      const playerElement = document.getElementById("player");
      playerElement.src = playerImages[currentImageIndex];

      // ä½ç½®æ›´æ–°ï¼ˆç”»é¢å¤–ã«å‡ºãªã„ã‚ˆã†åˆ¶å¾¡ï¼‰
      player.x += dx;
      player.y += dy;
      const pw = playerElement.offsetWidth;
      const ph = playerElement.offsetHeight;
      const maxX = window.innerWidth - pw;
      const maxY = document.getElementById("gameArea").clientHeight - ph;
      if (player.x < 0) player.x = 0;
      if (player.y < 0) player.y = 0;
      if (player.x > maxX) player.x = maxX;
      if (player.y > maxY) player.y = maxY;
      updatePlayerPosition();

      player.steps++;
      console.log("æ­©æ•°:", player.steps);
      if (player.steps - lastEncounterSteps >= encounterThreshold) {
        startEncounter();
      }
    }
    function getRandomEncounterThreshold() {
      return Math.floor(Math.random() * 11) + 5; // 5ï½15
    }
function showGameOverOptions() {
  const topTextBox = document.getElementById("top-text-box");
  topTextBox.textContent = "ğŸ’€ HPãŒå°½ããŸâ€¦ã©ã†ã™ã‚‹ï¼Ÿ";

  const choiceArea = document.getElementById("choice-area");
  choiceArea.innerHTML = ""; // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚’æ¶ˆå»

function showGameOverOptions() {
  const topTextBox = document.getElementById("top-text-box");
  topTextBox.textContent = "ğŸ’€ HPãŒå°½ããŸâ€¦ã©ã†ã™ã‚‹ï¼Ÿ";

  const choiceArea = document.getElementById("choice-area");
  choiceArea.innerHTML = ""; // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚’æ¶ˆå»

  const retryButton = document.createElement("button");
  retryButton.textContent = "å†æŒ‘æˆ¦ã™ã‚‹";
  retryButton.className = "choice-button";
  retryButton.onclick = () => retryBattle(); // âœ… ä¿®æ­£

  const churchButton = document.createElement("button");
  churchButton.textContent = "æ•™ä¼šã‹ã‚‰å†é–‹";
  churchButton.className = "choice-button";
  churchButton.onclick = () => restartFromChurch(); // âœ… ä¿®æ­£

  choiceArea.appendChild(retryButton);
  choiceArea.appendChild(churchButton);
}



// ã€Œæ•™ä¼šã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã€é–¢æ•°
function restartFromChurch() {
  const topTextBox = document.getElementById("top-text-box");
  topTextBox.textContent = "æ•™ä¼šã§å¾©æ´»â€¦ ãŠé‡‘ãŒåŠåˆ†ã«ãªã‚Šã¾ã—ãŸï¼";

  // BGMã‚„åŠ¹æœéŸ³ã®åœæ­¢
  stopQuizBgm();
  stopBattleBgm();

  // æ‰€æŒé‡‘ã‚’åŠåˆ†ã«ï¼ˆæœ€ä½1Gæ®‹ã™ï¼‰
  playerData.g = Math.max(1, Math.floor(playerData.g / 2));

  // HPå…¨å›å¾©
  playerData.hp = 50;
  updatePlayerStatusUI();
  savePlayerData();

  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”»é¢ã«æˆ»ã‚‹
  document.getElementById("battle-screen").style.display = "none";
  document.getElementById("gameArea").style.display = "block";
  inBattle = false;
  playFieldBgm();
}

    // --- æˆ¦é—˜é–¢é€£ ---
    function startEncounter() {
      inBattle = true;
      stopFieldBgm();
      stopQuizBgm();
      lastEncounterSteps = player.steps;
      encounterThreshold = getRandomEncounterThreshold();

      const overlay = document.getElementById("transition-overlay");
      const circle = document.getElementById("transition-circle");
      overlay.style.display = "block";
      requestAnimationFrame(() => { circle.classList.add("active"); });
      setTimeout(() => {
        document.getElementById("gameArea").style.display = "none";
        document.getElementById("battle-screen").style.display = "block";
        overlay.style.display = "none";
        circle.classList.remove("active");
        playQuizBgm();
        startBattleInit();
      }, 800);
    }
    function startBattleInit() {
  correctCount = 0;
  missCount = 0;

  // ğŸ”¹ ã‚¯ã‚¤ã‚ºé–‹å§‹æ™‚ã®HPã‚’è¨˜éŒ²
  battleStartHp = playerData.hp;

  document.getElementById("quiz-image").style.display = "none";
  document.getElementById("choice-area").innerHTML = "";
  document.getElementById("zaorikuButton").style.display = "none";
  initHearts();
}
      function initHearts() {
      const heartsContainer = document.getElementById("hearts-container");
      heartsContainer.innerHTML = "";
      for (let i = 0; i < 4; i++) {
        const heart = document.createElement("span");
        heart.className = "heart";
        heart.textContent = "â™¡";
        heartsContainer.appendChild(heart);
      }
      const currentMonsters = getRandomMonsters();
      showMonsters(currentMonsters);
      const topTextBox = document.getElementById("top-text-box");
      topTextBox.textContent = "mamãŒã‚ã‚‰ã‚ã‚ŒãŸï¼";
      setTimeout(() => { topTextBox.textContent = ""; }, 2000);
      setTimeout(() => { topTextBox.textContent = "mamã®å¾©ç¿’æ”»æ’ƒï¼"; }, 3000);
      setTimeout(() => {
        topTextBox.textContent = "ã‚¯ã‚¤ã‚ºé–‹å§‹ï¼";
        showQuiz();
      }, 5000);
    }
    function shakeAndRemoveHeart() {
      const heartsContainer = document.getElementById("hearts-container");
      if (heartsContainer.children.length > 0) {
        const firstHeart = heartsContainer.children[0];
        firstHeart.classList.add("shake");
        setTimeout(() => {
          if (heartsContainer.contains(firstHeart)) {
            heartsContainer.removeChild(firstHeart);
          }
        }, 500);
      }
    }
    function shakeGameScreen() {
      const battleScreen = document.getElementById("battle-screen");
      battleScreen.classList.add("shake");
      setTimeout(() => {
        battleScreen.classList.remove("shake");
      }, 500);
    }
    function shakeAndRemoveMonster() {
      const container = document.getElementById("enemy-container");
      if (container.children.length > 0) {
        const firstMonster = container.children[0];
        firstMonster.classList.add("shake");
        setTimeout(() => {
          if (container.contains(firstMonster)) {
            container.removeChild(firstMonster);
          }
        }, 500);
      }
    }
    function showMonsters(monsters) {
      const container = document.getElementById("enemy-container");
      container.innerHTML = "";
      monsters.forEach(monster => {
        const img = document.createElement("img");
        img.className = "monster";
        img.src = monster.url;
        img.alt = monster.name;
        container.appendChild(img);
      });
    }
function showQuiz() {
  // ğŸš¨ HPãŒ0ãªã‚‰ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã›ãšã«ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã¸
  if (playerData.hp === 0) { 
    showGameOverOptions();
    return;
  }

  const quiz = getRandomQuiz();
  const topTextBox = document.getElementById("top-text-box");
  const quizImage = document.getElementById("quiz-image");
  const choiceArea = document.getElementById("choice-area");

  if (!quiz) {
    topTextBox.textContent = "ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“";
    return;
  }

  // ğŸ”½ ç”»åƒã‚’ãƒªã‚»ãƒƒãƒˆ
  quizImage.src = "";
  quizImage.style.display = "none";

  topTextBox.textContent = quiz.question;

  if (quiz.imageUrl) {
    setTimeout(() => {
      quizImage.src = quiz.imageUrl;
      quizImage.style.display = "block";
    }, 100);
  }

  // é¸æŠè‚¢ã‚’ä½œæˆ
  choiceArea.innerHTML = "";
  quiz.choices.forEach((choice, index) => {
    const btn = document.createElement("button");
    btn.className = "choice-button";
    btn.textContent = choice;
    btn.onclick = () => {
      disableChoiceButtons();
      handleAnswer(index + 1, quiz);
    };
    choiceArea.appendChild(btn);
  });
}

    function disableChoiceButtons() {
      const buttons = document.querySelectorAll("#choice-area button");
      buttons.forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = "0.5";
      });
    }
    
    
function handleAnswer(selected, quiz) {
  const topTextBox = document.getElementById("top-text-box");
  disableChoiceButtons();

  if (selected === quiz.correct) {
    correctCount++;
    topTextBox.textContent = "âœ… æ­£è§£ï¼ " + (quiz.explanation || "");
    shakeAndRemoveMonster();

    addExp(20);
    playerData.g += 5;
    savePlayerData();
  } else {
    missCount++;
    topTextBox.textContent = "âŒ ä¸æ­£è§£ï¼ " + (quiz.explanation || "");
    shakeGameScreen();
    shakeAndRemoveHeart();

    changeHp(-10); // âŒ ãƒŸã‚¹ã—ãŸã‚‰HPæ¸›å°‘

    if (quiz.questionId) {
      recordMistake(playerData.name, quiz.questionId);
    } else {
      console.error("â›” ã‚¨ãƒ©ãƒ¼: `quiz.questionId` ãŒ `undefined` ã§ã™ï¼", quiz);
    }
  }

  setTimeout(() => {
    if (playerData.hp === 0) {
      // ğŸ¯ HPãŒ0ã«ãªã£ãŸã‚‰ã‚¯ã‚¤ã‚ºã‚’é€²ã‚ãšã€ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã®é¸æŠè‚¢ã‚’è¡¨ç¤º
      showGameOverOptions();
      return;
    }

    if (correctCount >= MAX_CORRECT) {
      // ğŸ¯ 4å•æ­£è§£ã—ãŸã‚‰æˆ¦é—˜çµ‚äº†
      topTextBox.textContent = "mamã¯å®‰å¿ƒã—ã¦å»ã£ã¦ã„ã£ãŸï¼";
      stopQuizBgm();
      endBattle();
    } else {
      // ğŸ¯ ã¾ã ã‚¯ã‚¤ã‚ºã‚’ç¶šã‘ã‚‹
      showQuiz();
    }
  }, 3000);
}

    function recordMistake(playerName, questionId) {
  const params = new URLSearchParams();
  params.append("player", playerName);
  params.append("questionId", questionId);

  fetch(GAS_PERSONAL_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: params
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log(`âœ… ${playerName} ã®é–“é•ã„è¨˜éŒ²ã‚’æ›´æ–°: å•é¡Œ ${questionId}`);
    } else {
      console.error("â›” è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:", data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼");
    }
  })
  .catch(error => {
    console.error("â›” ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼:", error);
  });
}
    

    function onZaoriku() {
      document.getElementById("zaorikuButton").style.display = "none";
      const dqAudio = document.getElementById("dqDownAudio");
      dqAudio.pause();
      dqAudio.currentTime = 0;
      stopFieldBgm();
      stopBattleBgm();
      stopQuizBgm();
      document.getElementById("top-text-box").textContent = "ã‚¶ã‚ªãƒªã‚¯ãŒå”±ãˆã‚‰ã‚ŒãŸï¼";
      setTimeout(() => { endBattle(); }, 500);
    }
    function endBattle() {
      stopBattleBgm();
      stopQuizBgm();
      document.getElementById("battle-screen").style.display = "none";
      document.getElementById("gameArea").style.display = "block";
      inBattle = false;
      updateBgmButton();
      setTimeout(() => {
        if (isBgmPlaying) {
          playFieldBgm();
        }
      }, 1000);
    }
  </script>
</body>
</html>
