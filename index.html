<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Tile Map Example</title>
  <style>
    body {
      background: #eee;
      margin: 20px;
    }
    #gameCanvas {
      background: #000; /* デフォルト背景（マップ外）が黒 */
      image-rendering: pixelated; /* ドット絵がぼやけないようにするための設定 */
    }
    pre {
      display: none; /* マップデータを隠す */
    }
  </style>
</head>
<body>

<h1>タイルマップ表示テスト</h1>
<canvas id="gameCanvas" width="256" height="256"></canvas>

<!-- マップデータをHTML内に埋め込む場合の例。見せたくないなら display:none などで隠す -->
<pre id="mapData">
MAP_VER_1_0_2;
CANVASWIDTH:256;
CANVASHEIGHT:256;
MAPX:16;
MAPY:16;
BGCOLOR:#000000;
BGALPHA:0;
L1PX:0;
L1PY:0;
L2PX:0;
L2PY:0;
L3PX:0;
L3PY:0;
L4PX:0;
L4PY:0;
L5PX:0;
L5PY:0;
L6PX:0;
L6PY:0;
LAYER:1;
0,0:121;
0,1:122;
0,2:122;
0,3:122;
0,4:133;
0,5:133;
0,6:122;
0,7:122;
0,8:122;
0,9:122;
0,10:122;
0,11:122;
0,12:122;
0,13:122;
0,14:122;
0,15:122;
1,0:121;
1,1:101;
1,2:122;
1,3:122;
1,4:112;
1,5:112;
1,6:101;
1,7:101;
1,8:101;
1,9:122;
1,10:112;
1,11:109;
1,12:122;
1,13:122;
1,14:112;
1,15:122;
2,0:121;
2,1:101;
2,2:101;
2,3:122;
2,4:112;
2,5:112;
2,6:101;
2,7:101;
2,8:101;
2,9:122;
2,10:112;
2,11:103;
2,12:109;
2,13:122;
2,14:112;
2,15:122;
3,0:121;
3,1:101;
3,2:101;
3,3:101;
3,4:112;
3,5:112;
3,6:101;
3,7:101;
3,8:101;
3,9:101;
3,10:112;
3,11:103;
3,12:164;
3,13:133;
3,14:112;
3,15:122;
4,0:121;
4,1:101;
4,2:101;
4,3:101;
4,4:112;
4,5:112;
4,6:101;
4,7:101;
4,8:101;
4,9:101;
4,10:112;
4,11:103;
4,12:109;
4,13:122;
4,14:112;
4,15:122;
5,0:121;
5,1:101;
5,2:101;
5,3:101;
5,4:112;
5,5:112;
5,6:101;
5,7:101;
5,8:101;
5,9:101;
5,10:112;
5,11:103;
5,12:109;
5,13:122;
5,14:112;
5,15:122;
6,0:121;
6,1:101;
6,2:101;
6,3:101;
6,4:112;
6,5:112;
6,6:101;
6,7:101;
6,8:101;
6,9:101;
6,10:112;
6,11:109;
6,12:122;
6,13:122;
6,14:112;
6,15:122;
7,0:112;
7,1:112;
7,2:112;
7,3:112;
7,4:112;
7,5:112;
7,6:101;
7,7:101;
7,8:101;
7,9:101;
7,10:112;
7,11:112;
7,12:112;
7,13:112;
7,14:112;
7,15:122;
8,0:112;
8,1:112;
8,2:112;
8,3:112;
8,4:112;
8,5:112;
8,6:112;
8,7:112;
8,8:112;
8,9:112;
8,10:112;
8,11:112;
8,12:112;
8,13:112;
8,14:112;
8,15:122;
9,0:121;
9,1:101;
9,2:112;
9,3:101;
9,4:101;
9,5:101;
9,6:101;
9,7:101;
9,8:101;
9,9:112;
9,10:101;
9,11:101;
9,12:101;
9,13:101;
9,14:101;
9,15:122;
10,0:121;
10,1:101;
10,2:112;
10,3:101;
10,4:101;
10,5:101;
10,6:101;
10,7:101;
10,8:101;
10,9:112;
10,10:103;
10,11:103;
10,12:101;
10,13:101;
10,14:101;
10,15:122;
11,0:121;
11,1:101;
11,2:101;
11,3:122;
11,4:122;
11,5:101;
11,6:101;
11,7:101;
11,8:101;
11,9:112;
11,10:112;
11,11:103;
11,12:175;
11,13:177;
11,14:101;
11,15:122;
12,0:121;
12,1:101;
12,2:101;
12,3:122;
12,4:122;
12,5:122;
12,6:101;
12,7:112;
12,8:101;
12,9:101;
12,10:103;
12,11:103;
12,12:171;
12,13:172;
12,14:101;
12,15:122;
13,0:121;
13,1:101;
13,2:101;
13,3:122;
13,4:122;
13,5:122;
13,6:101;
13,7:112;
13,8:101;
13,9:101;
13,10:101;
13,11:101;
13,12:176;
13,13:178;
13,14:101;
13,15:122;
14,0:121;
14,1:101;
14,2:101;
14,3:122;
14,4:122;
14,5:122;
14,6:122;
14,7:112;
14,8:101;
14,9:101;
14,10:101;
14,11:101;
14,12:101;
14,13:101;
14,14:101;
14,15:122;
15,0:121;
15,1:122;
15,2:122;
15,3:122;
15,4:122;
15,5:122;
15,6:122;
15,7:122;
15,8:122;
15,9:122;
15,10:122;
15,11:122;
15,12:122;
15,13:122;
15,14:122;
15,15:122;
LAYER:2;
0,0:;
0,1:;
0,2:;
0,3:;
0,4:;
0,5:;
0,6:;
0,7:;
0,8:;
0,9:;
0,10:;
0,11:;
0,12:;
0,13:;
0,14:;
0,15:;
1,0:;
1,1:;
1,2:;
1,3:;
1,4:;
1,5:;
1,6:;
1,7:;
1,8:;
1,9:;
1,10:;
1,11:;
1,12:;
1,13:;
1,14:;
1,15:;
2,0:;
2,1:;
2,2:;
2,3:;
2,4:;
2,5:;
2,6:;
2,7:;
2,8:;
2,9:;
2,10:;
2,11:;
2,12:;
2,13:;
2,14:;
2,15:;
3,0:;
3,1:;
3,2:;
3,3:;
3,4:;
3,5:;
3,6:;
3,7:;
3,8:;
3,9:;
3,10:;
3,11:;
3,12:;
3,13:;
3,14:;
3,15:;
4,0:;
4,1:;
4,2:;
4,3:;
4,4:;
4,5:;
4,6:;
4,7:;
4,8:;
4,9:;
4,10:;
4,11:;
4,12:;
4,13:;
4,14:;
4,15:;
5,0:;
5,1:;
5,2:;
5,3:;
5,4:;
5,5:;
5,6:;
5,7:;
5,8:;
5,9:;
5,10:;
5,11:;
5,12:;
5,13:;
5,14:;
5,15:;
6,0:;
6,1:;
6,2:;
6,3:;
6,4:;
6,5:;
6,6:;
6,7:;
6,8:;
6,9:;
6,10:;
6,11:;
6,12:;
6,13:;
6,14:;
6,15:;
7,0:;
7,1:;
7,2:;
7,3:;
7,4:;
7,5:;
7,6:;
7,7:;
7,8:;
7,9:;
7,10:;
7,11:;
7,12:;
7,13:;
7,14:;
7,15:;
8,0:;
8,1:;
8,2:;
8,3:;
8,4:;
8,5:;
8,6:;
8,7:;
8,8:;
8,9:;
8,10:;
8,11:;
8,12:;
8,13:;
8,14:;
8,15:;
9,0:;
9,1:;
9,2:;
9,3:;
9,4:;
9,5:;
9,6:;
9,7:;
9,8:;
9,9:;
9,10:;
9,11:;
9,12:;
9,13:;
9,14:;
9,15:;
10,0:;
10,1:;
10,2:;
10,3:;
10,4:;
10,5:;
10,6:;
10,7:;
10,8:;
10,9:;
10,10:;
10,11:;
10,12:;
10,13:;
10,14:;
10,15:;
11,0:;
11,1:;
11,2:;
11,3:;
11,4:;
11,5:;
11,6:;
11,7:;
11,8:;
11,9:;
11,10:;
11,11:;
11,12:;
11,13:;
11,14:;
11,15:;
12,0:;
12,1:;
12,2:;
12,3:;
12,4:;
12,5:;
12,6:;
12,7:;
12,8:;
12,9:;
12,10:;
12,11:;
12,12:;
12,13:;
12,14:;
12,15:;
13,0:;
13,1:;
13,2:;
13,3:;
13,4:;
13,5:;
13,6:;
13,7:;
13,8:;
13,9:;
13,10:;
13,11:;
13,12:;
13,13:;
13,14:;
13,15:;
14,0:;
14,1:;
14,2:;
14,3:;
14,4:;
14,5:;
14,6:;
14,7:;
14,8:;
14,9:;
14,10:;
14,11:;
14,12:;
14,13:;
14,14:;
14,15:;
15,0:;
15,1:;
15,2:;
15,3:;
15,4:;
15,5:;
15,6:;
15,7:;
15,8:;
15,9:;
15,10:;
15,11:;
15,12:;
15,13:;
15,14:;
15,15:;
LAYER:3;
0,0:;
0,1:;
0,2:;
0,3:;
0,4:;
0,5:;
0,6:;
0,7:;
0,8:;
0,9:;
0,10:;
0,11:;
0,12:;
0,13:;
0,14:;
0,15:;
1,0:;
1,1:;
1,2:;
1,3:;
1,4:;
1,5:;
1,6:;
1,7:;
1,8:;
1,9:;
1,10:;
1,11:;
1,12:;
1,13:;
1,14:;
1,15:;
2,0:;
2,1:;
2,2:;
2,3:;
2,4:;
2,5:;
2,6:;
2,7:;
2,8:;
2,9:;
2,10:;
2,11:;
2,12:;
2,13:;
2,14:;
2,15:;
3,0:;
3,1:;
3,2:;
3,3:;
3,4:;
3,5:;
3,6:;
3,7:;
3,8:;
3,9:;
3,10:;
3,11:;
3,12:;
3,13:;
3,14:;
3,15:;
4,0:;
4,1:;
4,2:;
4,3:;
4,4:;
4,5:;
4,6:;
4,7:;
4,8:;
4,9:;
4,10:;
4,11:;
4,12:;
4,13:;
4,14:;
4,15:;
5,0:;
5,1:;
5,2:;
5,3:;
5,4:;
5,5:;
5,6:;
5,7:;
5,8:;
5,9:;
5,10:;
5,11:;
5,12:;
5,13:;
5,14:;
5,15:;
6,0:;
6,1:;
6,2:;
6,3:;
6,4:;
6,5:;
6,6:;
6,7:;
6,8:;
6,9:;
6,10:;
6,11:;
6,12:;
6,13:;
6,14:;
6,15:;
7,0:;
7,1:;
7,2:;
7,3:;
7,4:;
7,5:;
7,6:;
7,7:;
7,8:;
7,9:;
7,10:;
7,11:;
7,12:;
7,13:;
7,14:;
7,15:;
8,0:;
8,1:;
8,2:;
8,3:;
8,4:;
8,5:;
8,6:;
8,7:;
8,8:;
8,9:;
8,10:;
8,11:;
8,12:;
8,13:;
8,14:;
8,15:;
9,0:;
9,1:;
9,2:;
9,3:;
9,4:;
9,5:;
9,6:;
9,7:;
9,8:;
9,9:;
9,10:;
9,11:;
9,12:;
9,13:;
9,14:;
9,15:;
10,0:;
10,1:;
10,2:;
10,3:;
10,4:;
10,5:;
10,6:;
10,7:;
10,8:;
10,9:;
10,10:;
10,11:;
10,12:;
10,13:;
10,14:;
10,15:;
11,0:;
11,1:;
11,2:;
11,3:;
11,4:;
11,5:;
11,6:;
11,7:;
11,8:;
11,9:;
11,10:;
11,11:;
11,12:;
11,13:;
11,14:;
11,15:;
12,0:;
12,1:;
12,2:;
12,3:;
12,4:;
12,5:;
12,6:;
12,7:;
12,8:;
12,9:;
12,10:;
12,11:;
12,12:;
12,13:;
12,14:;
12,15:;
13,0:;
13,1:;
13,2:;
13,3:;
13,4:;
13,5:;
13,6:;
13,7:;
13,8:;
13,9:;
13,10:;
13,11:;
13,12:;
13,13:;
13,14:;
13,15:;
14,0:;
14,1:;
14,2:;
14,3:;
14,4:;
14,5:;
14,6:;
14,7:;
14,8:;
14,9:;
14,10:;
14,11:;
14,12:;
14,13:;
14,14:;
14,15:;
15,0:;
15,1:;
15,2:;
15,3:;
15,4:;
15,5:;
15,6:;
15,7:;
15,8:;
15,9:;
15,10:;
15,11:;
15,12:;
15,13:;
15,14:;
15,15:;
LAYER:4;
0,0:;
0,1:;
0,2:;
0,3:;
0,4:;
0,5:;
0,6:;
0,7:;
0,8:;
0,9:;
0,10:;
0,11:;
0,12:;
0,13:;
0,14:;
0,15:;
1,0:;
1,1:;
1,2:;
1,3:;
1,4:;
1,5:;
1,6:;
1,7:;
1,8:;
1,9:;
1,10:;
1,11:;
1,12:;
1,13:;
1,14:;
1,15:;
2,0:;
2,1:;
2,2:;
2,3:;
2,4:;
2,5:;
2,6:;
2,7:;
2,8:;
2,9:;
2,10:;
2,11:;
2,12:;
2,13:;
2,14:;
2,15:;
3,0:;
3,1:;
3,2:;
3,3:;
3,4:;
3,5:;
3,6:;
3,7:;
3,8:;
3,9:;
3,10:;
3,11:;
3,12:;
3,13:;
3,14:;
3,15:;
4,0:;
4,1:;
4,2:;
4,3:;
4,4:;
4,5:;
4,6:;
4,7:;
4,8:;
4,9:;
4,10:;
4,11:;
4,12:;
4,13:;
4,14:;
4,15:;
5,0:;
5,1:;
5,2:;
5,3:;
5,4:;
5,5:;
5,6:;
5,7:;
5,8:;
5,9:;
5,10:;
5,11:;
5,12:;
5,13:;
5,14:;
5,15:;
6,0:;
6,1:;
6,2:;
6,3:;
6,4:;
6,5:;
6,6:;
6,7:;
6,8:;
6,9:;
6,10:;
6,11:;
6,12:;
6,13:;
6,14:;
6,15:;
7,0:;
7,1:;
7,2:;
7,3:;
7,4:;
7,5:;
7,6:;
7,7:;
7,8:;
7,9:;
7,10:;
7,11:;
7,12:;
7,13:;
7,14:;
7,15:;
8,0:;
8,1:;
8,2:;
8,3:;
8,4:;
8,5:;
8,6:;
8,7:;
8,8:;
8,9:;
8,10:;
8,11:;
8,12:;
8,13:;
8,14:;
8,15:;
9,0:;
9,1:;
9,2:;
9,3:;
9,4:;
9,5:;
9,6:;
9,7:;
9,8:;
9,9:;
9,10:;
9,11:;
9,12:;
9,13:;
9,14:;
9,15:;
10,0:;
10,1:;
10,2:;
10,3:;
10,4:;
10,5:;
10,6:;
10,7:;
10,8:;
10,9:;
10,10:;
10,11:;
10,12:;
10,13:;
10,14:;
10,15:;
11,0:;
11,1:;
11,2:;
11,3:;
11,4:;
11,5:;
11,6:;
11,7:;
11,8:;
11,9:;
11,10:;
11,11:;
11,12:101;
11,13:101;
11,14:;
11,15:;
12,0:;
12,1:;
12,2:;
12,3:;
12,4:;
12,5:;
12,6:;
12,7:;
12,8:;
12,9:;
12,10:;
12,11:;
12,12:101;
12,13:101;
12,14:;
12,15:;
13,0:;
13,1:;
13,2:;
13,3:;
13,4:;
13,5:;
13,6:;
13,7:;
13,8:;
13,9:;
13,10:;
13,11:;
13,12:101;
13,13:101;
13,14:;
13,15:;
14,0:;
14,1:;
14,2:;
14,3:;
14,4:;
14,5:;
14,6:;
14,7:;
14,8:;
14,9:;
14,10:;
14,11:;
14,12:;
14,13:;
14,14:;
14,15:;
15,0:;
15,1:;
15,2:;
15,3:;
15,4:;
15,5:;
15,6:;
15,7:;
15,8:;
15,9:;
15,10:;
15,11:;
15,12:;
15,13:;
15,14:;
15,15:;
LAYER:5;
0,0:;
0,1:;
0,2:;
0,3:;
0,4:;
0,5:;
0,6:;
0,7:;
0,8:;
0,9:;
0,10:;
0,11:;
0,12:;
0,13:;
0,14:;
0,15:;
1,0:;
1,1:;
1,2:;
1,3:;
1,4:;
1,5:;
1,6:;
1,7:;
1,8:;
1,9:;
1,10:;
1,11:;
1,12:;
1,13:;
1,14:;
1,15:;
2,0:;
2,1:;
2,2:;
2,3:;
2,4:;
2,5:;
2,6:;
2,7:;
2,8:;
2,9:;
2,10:;
2,11:;
2,12:;
2,13:;
2,14:;
2,15:;
3,0:;
3,1:;
3,2:;
3,3:;
3,4:;
3,5:;
3,6:;
3,7:;
3,8:;
3,9:;
3,10:;
3,11:;
3,12:;
3,13:;
3,14:;
3,15:;
4,0:;
4,1:;
4,2:;
4,3:;
4,4:;
4,5:;
4,6:;
4,7:;
4,8:;
4,9:;
4,10:;
4,11:;
4,12:;
4,13:;
4,14:;
4,15:;
5,0:;
5,1:;
5,2:;
5,3:;
5,4:;
5,5:;
5,6:;
5,7:;
5,8:;
5,9:;
5,10:;
5,11:;
5,12:;
5,13:;
5,14:;
5,15:;
6,0:;
6,1:;
6,2:;
6,3:;
6,4:;
6,5:;
6,6:;
6,7:;
6,8:;
6,9:;
6,10:;
6,11:;
6,12:;
6,13:;
6,14:;
6,15:;
7,0:;
7,1:;
7,2:;
7,3:;
7,4:;
7,5:;
7,6:;
7,7:;
7,8:;
7,9:;
7,10:;
7,11:;
7,12:;
7,13:;
7,14:;
7,15:;
8,0:;
8,1:;
8,2:;
8,3:;
8,4:;
8,5:;
8,6:;
8,7:;
8,8:;
8,9:;
8,10:;
8,11:;
8,12:;
8,13:;
8,14:;
8,15:;
9,0:;
9,1:;
9,2:;
9,3:;
9,4:;
9,5:;
9,6:;
9,7:;
9,8:;
9,9:;
9,10:;
9,11:;
9,12:;
9,13:;
9,14:;
9,15:;
10,0:;
10,1:;
10,2:;
10,3:;
10,4:;
10,5:;
10,6:;
10,7:;
10,8:;
10,9:;
10,10:;
10,11:;
10,12:;
10,13:;
10,14:;
10,15:;
11,0:;
11,1:;
11,2:;
11,3:;
11,4:;
11,5:;
11,6:;
11,7:;
11,8:;
11,9:;
11,10:;
11,11:;
11,12:;
11,13:;
11,14:;
11,15:;
12,0:;
12,1:;
12,2:;
12,3:;
12,4:;
12,5:;
12,6:;
12,7:;
12,8:;
12,9:;
12,10:;
12,11:;
12,12:;
12,13:;
12,14:;
12,15:;
13,0:;
13,1:;
13,2:;
13,3:;
13,4:;
13,5:;
13,6:;
13,7:;
13,8:;
13,9:;
13,10:;
13,11:;
13,12:;
13,13:;
13,14:;
13,15:;
14,0:;
14,1:;
14,2:;
14,3:;
14,4:;
14,5:;
14,6:;
14,7:;
14,8:;
14,9:;
14,10:;
14,11:;
14,12:;
14,13:;
14,14:;
14,15:;
15,0:;
15,1:;
15,2:;
15,3:;
15,4:;
15,5:;
15,6:;
15,7:;
15,8:;
15,9:;
15,10:;
15,11:;
15,12:;
15,13:;
15,14:;
15,15:;
LAYER:6;
0,0:;
0,1:;
0,2:;
0,3:;
0,4:;
0,5:;
0,6:;
0,7:;
0,8:;
0,9:;
0,10:;
0,11:;
0,12:;
0,13:;
0,14:;
0,15:;
1,0:;
1,1:;
1,2:;
1,3:;
1,4:;
1,5:;
1,6:;
1,7:;
1,8:;
1,9:;
1,10:;
1,11:;
1,12:;
1,13:;
1,14:;
1,15:;
2,0:;
2,1:;
2,2:;
2,3:;
2,4:;
2,5:;
2,6:;
2,7:;
2,8:;
2,9:;
2,10:;
2,11:;
2,12:;
2,13:;
2,14:;
2,15:;
3,0:;
3,1:;
3,2:;
3,3:;
3,4:;
3,5:;
3,6:;
3,7:;
3,8:;
3,9:;
3,10:;
3,11:;
3,12:;
3,13:;
3,14:;
3,15:;
4,0:;
4,1:;
4,2:;
4,3:;
4,4:;
4,5:;
4,6:;
4,7:;
4,8:;
4,9:;
4,10:;
4,11:;
4,12:;
4,13:;
4,14:;
4,15:;
5,0:;
5,1:;
5,2:;
5,3:;
5,4:;
5,5:;
5,6:;
5,7:;
5,8:;
5,9:;
5,10:;
5,11:;
5,12:;
5,13:;
5,14:;
5,15:;
6,0:;
6,1:;
6,2:;
6,3:;
6,4:;
6,5:;
6,6:;
6,7:;
6,8:;
6,9:;
6,10:;
6,11:;
6,12:;
6,13:;
6,14:;
6,15:;
7,0:;
7,1:;
7,2:;
7,3:;
7,4:;
7,5:;
7,6:;
7,7:;
7,8:;
7,9:;
7,10:;
7,11:;
7,12:;
7,13:;
7,14:;
7,15:;
8,0:;
8,1:;
8,2:;
8,3:;
8,4:;
8,5:;
8,6:;
8,7:;
8,8:;
8,9:;
8,10:;
8,11:;
8,12:;
8,13:;
8,14:;
8,15:;
9,0:;
9,1:;
9,2:;
9,3:;
9,4:;
9,5:;
9,6:;
9,7:;
9,8:;
9,9:;
9,10:;
9,11:;
9,12:;
9,13:;
9,14:;
9,15:;
10,0:;
10,1:;
10,2:;
10,3:;
10,4:;
10,5:;
10,6:;
10,7:;
10,8:;
10,9:;
10,10:;
10,11:;
10,12:;
10,13:;
10,14:;
10,15:;
11,0:;
11,1:;
11,2:;
11,3:;
11,4:;
11,5:;
11,6:;
11,7:;
11,8:;
11,9:;
11,10:;
11,11:;
11,12:;
11,13:;
11,14:;
11,15:;
12,0:;
12,1:;
12,2:;
12,3:;
12,4:;
12,5:;
12,6:;
12,7:;
12,8:;
12,9:;
12,10:;
12,11:;
12,12:;
12,13:;
12,14:;
12,15:;
13,0:;
13,1:;
13,2:;
13,3:;
13,4:;
13,5:;
13,6:;
13,7:;
13,8:;
13,9:;
13,10:;
13,11:;
13,12:;
13,13:;
13,14:;
13,15:;
14,0:;
14,1:;
14,2:;
14,3:;
14,4:;
14,5:;
14,6:;
14,7:;
14,8:;
14,9:;
14,10:;
14,11:;
14,12:;
14,13:;
14,14:;
14,15:;
15,0:;
15,1:;
15,2:;
15,3:;
15,4:;
15,5:;
15,6:;
15,7:;
15,8:;
15,9:;
15,10:;
15,11:;
15,12:;
15,13:;
15,14:;
15,15:;
END;
</pre>

<script>
/* -------------------------------------
 *  タイルID と 画像ファイル名 の対応
 * ------------------------------------- */
const tileSize = 16;  // 1タイルのサイズ(px)
// 例: tileDict のサンプル
const tileDict = {
  "121": "121ipponnnoki.png",
  "101": "101grass.png",
  "122": "122nihonnnoki.png",
  "112": "112soil.png",
  "109": "109gake.png",
  "103": "103hanabatake.png",
  "164": "164horaana.png",
  "133": "133kirikabu.png"
};

/* -------------------------------------
 *  マップデータを読み込み、パースする
 * ------------------------------------- */
function parseMapData(rawText) {
  // レイヤーごとに 16x16 の配列を作り、格納していく
  // layers[レイヤー番号] = [[タイルID, ...], [...], ...] の形式を想定
  const layers = {};
  let currentLayer = 0;

  // 行単位で分割
  const lines = rawText.split(/\r?\n/);
  for (let line of lines) {
    line = line.trim();
    // レイヤー切り替え検出
    if (line.startsWith("LAYER:")) {
      currentLayer = parseInt(line.replace("LAYER:", ""), 10);
      layers[currentLayer] = createEmptyMapArray(16, 16); // 16x16の空配列
    }
    // マップデータ検出 (例: 0,0:121;)
    else if (/^\d+,\d+:/.test(line)) {
      // 例: "0,0:121;" → row=0, col=0, tileId=121
      const [pos, tilePart] = line.split(":");
      const [r, c] = pos.split(",").map(Number);
      // "121;" から ";" を除去して数値化
      const tileId = parseInt(tilePart.replace(";", ""), 10);

      // layers[currentLayer][row][col] = tileId
      if (!isNaN(tileId)) {
        layers[currentLayer][r][c] = tileId;
      }
    }
  }
  return layers;
}

// 指定サイズの2次元配列を作るユーティリティ
function createEmptyMapArray(rows, cols) {
  const arr = [];
  for (let r = 0; r < rows; r++) {
    arr[r] = [];
    for (let c = 0; c < cols; c++) {
      arr[r][c] = 0; // 0 = タイルなし
    }
  }
  return arr;
}

/* -------------------------------------
 *  Canvasにタイルを描画する
 * ------------------------------------- */
function drawMap(layers, context) {
  // レイヤーの小さい番号から順に描画する
  const layerKeys = Object.keys(layers).map(Number).sort((a,b)=>a-b);
  for (let layer of layerKeys) {
    const mapData = layers[layer];
    for (let row = 0; row < mapData.length; row++) {
      for (let col = 0; col < mapData[row].length; col++) {
        const tileId = mapData[row][col];
        if (tileId !== 0) {
          const imgFile = tileDict[tileId];
          if (imgFile) {
            // 画像を読み込んで描画（毎回ロードすると非効率なので、実際はキャッシュ推奨）
            const img = new Image();
            img.src = imgFile;
            // onload イベントで描画しないと、読み込む前に描画されない
            img.onload = () => {
              context.drawImage(img, col * tileSize, row * tileSize, tileSize, tileSize);
            };
          } else {
            // tileDictに登録されていないIDの場合の処理（エラー表示など）
            // console.log("未登録のタイルID:", tileId);
          }
        }
      }
    }
  }
}

/* -------------------------------------
 *  メイン処理
 * ------------------------------------- */
window.onload = function() {
  // Canvasとコンテキスト取得
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  // <pre>タグに埋め込んだマップデータを取得
  const rawMapText = document.getElementById("mapData").textContent;

  // パースしてレイヤーデータ取得
  const layers = parseMapData(rawMapText);

  // マップを描画
  drawMap(layers, ctx);
};
</script>

</body>
</html>
