<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>モンスター4体表示 & シェイク演出 + テキスト追加</title>
  <style>
    /* 画面全体やフィールドなどのCSSは省略し、必要部分だけ記載 */

    /* 戦闘画面 */
    #battle-screen {
      display: none;
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: black;
      padding: 20px;
      text-align: center;
      z-index: 100;
    }
    #top-text-box {
      border: 2px solid white;
      padding: 10px;
      margin-bottom: 10px;
      color: white;
      min-height: 50px; /* テキストが消えたとき高さが崩れないように */
    }
    #enemy-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .monster {
      width: 60px;
      height: 60px;
      object-fit: contain;
    }
    #quiz-image {
      display: none;
      width: 200px;
      height: 200px;
      margin: 10px auto;
    }
    .choice-button {
      display: block;
      margin: 10px auto;
      padding: 10px;
      width: 200px;
      font-size: 18px;
    }
    #explanation {
      display: none;
      color: yellow;
      margin: 10px;
    }
    #zaorikuButton {
      display: none;
      font-size: 20px;
      padding: 10px 20px;
      margin-top: 20px;
      cursor: pointer;
    }

    /* シェイクアニメーション */
    @keyframes shake {
      0%   { transform: translate(0, 0); }
      20%  { transform: translate(-5px, 0); }
      40%  { transform: translate(5px, 0); }
      60%  { transform: translate(-5px, 0); }
      80%  { transform: translate(5px, 0); }
      100% { transform: translate(0, 0); }
    }
    .shake {
      animation: shake 0.5s;
    }
  </style>
</head>
<body>
  <!-- ここにフィールド画面やステータスなど既存の要素がある想定 -->

  <!-- 戦闘画面 -->
  <div id="battle-screen">
    <div id="top-text-box"></div>
    <div id="enemy-container"></div>
    <img id="quiz-image" src="">
    <div id="choice-area"></div>
    <p id="explanation"></p>
    <button id="zaorikuButton" onclick="onZaoriku()">ザオリク</button>
  </div>

  <script>
    /* ▼ スプレッドシートのモンスター情報 (A列=ID, B列=名前, C列=URL) ▼ */
    const MONSTER_SHEET_ID = "1t08cjUMrug0nvIpredcxjuoxejDRazqqzLTqjVraJhw";
    const SHEET_NAME_MONSTER = "シート1"; // 実際のシート名に合わせる
    let monsterData = [];     // すべてのモンスター一覧
    let currentMonsters = []; // 今回選んだ4体

    /* クイズ正解・ミスのカウント */
    let correctCount = 0;
    let missCount = 0;
    const MAX_CORRECT = 4;
    const MAX_MISS = 4;

    /* クイズ用のデータ(例: B列=問題文, C列=画像, D~G=選択肢, H=正解) は別途 quizData[] で管理 */
    let quizData = []; // 既存のクイズ読み込みロジックを想定

    /* Google Sheets API でモンスターデータを読み込む */
    async function loadMonsterData() {
      try {
        const resp = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: MONSTER_SHEET_ID,
          range: `${SHEET_NAME_MONSTER}!A2:C1000`
        });
        monsterData = resp.result.values.map(row => ({
          id: row[0] || "",
          name: row[1] || "",
          url: row[2] || ""
        }));
        console.log("モンスターデータ:", monsterData);
      } catch (err) {
        console.error("モンスターデータ取得エラー:", err);
      }
    }

    /* 4体のモンスターをランダムに選ぶ */
    function getRandomMonsters() {
      if (monsterData.length < 4) {
        console.warn("モンスターが4体未満です");
        return [];
      }
      const shuffled = [...monsterData].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, 4);
    }

    /* モンスター画像を表示 */
    function showMonsters(monsters) {
      const container = document.getElementById("enemy-container");
      container.innerHTML = "";
      monsters.forEach(mon => {
        const img = document.createElement("img");
        img.className = "monster";
        img.src = mon.url;
        img.alt = mon.name;
        container.appendChild(img);
      });
    }

    /* 戦闘開始: モンスター4体表示 → テキスト演出 → クイズ開始 */
    function startBattle() {
      correctCount = 0;
      missCount = 0;
      document.getElementById("explanation").style.display = "none";
      document.getElementById("explanation").textContent = "";
      document.getElementById("zaorikuButton").style.display = "none";

      // 4体を選んで表示
      currentMonsters = getRandomMonsters();
      showMonsters(currentMonsters);

      // B列(名前)をまとめて文章にする
      const monsterNames = currentMonsters.map(m => m.name).join("、");

      // 戦闘冒頭テキスト
      const topTextBox = document.getElementById("top-text-box");
      topTextBox.textContent = monsterNames + "があらわれた！";

      // 2秒後にテキストを消す
      setTimeout(() => {
        topTextBox.textContent = "";
      }, 2000);

      // 3秒後に「○○の攻撃！」
      setTimeout(() => {
        topTextBox.textContent = monsterNames + "の攻撃！";
      }, 3000);

      // 5秒後に「クイズ開始！」 → showQuiz()
      setTimeout(() => {
        topTextBox.textContent = "クイズ開始！";
        showQuiz();
      }, 5000);
    }

    /* クイズ1問表示 */
    function showQuiz() {
      // 例: 既存の quizData からランダムに1問選ぶ
      const quiz = getRandomQuiz(); // 既存実装を想定
      if (!quiz) {
        document.getElementById("top-text-box").textContent = "クイズデータがありません";
        return;
      }

      // 問題文を表示
      document.getElementById("top-text-box").textContent = quiz.question;
      // 画像
      let quizImage = document.getElementById("quiz-image");
      quizImage.src = quiz.imageUrl;
      quizImage.style.display = quiz.imageUrl ? "block" : "none";

      // 選択肢ボタン
      let choiceArea = document.getElementById("choice-area");
      choiceArea.innerHTML = "";
      quiz.choices.forEach((choice, index) => {
        let btn = document.createElement("button");
        btn.className = "choice-button";
        btn.textContent = `▶ ${choice}`;
        btn.onclick = () => handleAnswer(index + 1, quiz);
        choiceArea.appendChild(btn);
      });
    }

    /* 回答処理 */
    function handleAnswer(selected, quiz) {
      // 解説欄をリセット
      const explanationElem = document.getElementById("explanation");
      explanationElem.style.display = "none";
      explanationElem.textContent = "";

      if (selected === quiz.correct) {
        correctCount++;
        alert("正解！");
        // 左端モンスターをシェイク→削除
        shakeAndRemoveMonster();
      } else {
        missCount++;
        alert("不正解...");
        // 解説を表示
        explanationElem.style.display = "block";
        explanationElem.textContent = quiz.explanation;
      }

      // 終了判定
      if (correctCount >= MAX_CORRECT) {
        alert("4回正解！モンスターを倒した！");
        endBattle();
        return;
      }
      if (missCount >= MAX_MISS) {
        alert("4回ミス...。");
        document.getElementById("zaorikuButton").style.display = "inline-block";
        return;
      }

      // 次の問題
      showQuiz();
    }

    /* 左端のモンスターをシェイクして削除 */
    function shakeAndRemoveMonster() {
      const container = document.getElementById("enemy-container");
      if (container.children.length > 0) {
        const firstMonster = container.children[0];
        firstMonster.classList.add("shake");
        setTimeout(() => {
          if (container.contains(firstMonster)) {
            container.removeChild(firstMonster);
          }
        }, 500);
      }
    }

    /* ザオリクボタン */
    function onZaoriku() {
      alert("ザオリクが唱えられた！ しかし何も起こらなかった...");
      // ここでゲームオーバー扱い or 戦闘終了扱いなど自由に実装
      endBattle();
    }

    /* 戦闘終了 → フィールドに戻る */
    function endBattle() {
      document.getElementById("battle-screen").style.display = "none";
      document.getElementById("gameArea").style.display = "block";
      // BGM切り替えなど必要ならここで
    }

    /* startEncounter() などで呼ばれる想定 */
    async function startEncounter() {
      // モンスターデータ未ロードなら読み込み
      if (monsterData.length === 0) {
        await loadMonsterData();
      }
      // 戦闘画面表示
      document.getElementById("battle-screen").style.display = "block";
      document.getElementById("gameArea").style.display = "none";

      startBattle(); // 上記の流れを開始
    }

    /* 既存のクイズ読み込みや OAuth 初期化は省略 */
    /* getRandomQuiz() も既存のクイズ実装に合わせて定義してください */
  </script>
</body>
</html>
