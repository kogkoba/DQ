<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ドラクエ風クイズゲーム - I列に間違い回数を更新</title>

  <!-- Google Identity Services 用のJS -->
  <script async defer src="https://accounts.google.com/gsi/client"></script>
  <!-- GAPI (Google Sheets API用) -->
  <script async defer src="https://apis.google.com/js/api.js"></script>

  <style>
    body {
      margin: 0; padding: 0; font-family: sans-serif;
      background-color: #f0f8ff;
    }
    h1 { text-align: center; margin-top: 10px; }

    /* ログインボタン */
    #login-btn {
      display: none;
      margin: 10px; padding: 8px 16px;
      font-size: 16px;
      background: #4285f4; color: #fff;
      border: none; border-radius: 4px;
      cursor: pointer;
    }

    /* フィールド画面 */
    #field-screen {
      display: block;
      width: 100vw; height: 80vh;
      background: url('https://placehold.jp/1200x600.png?text=Field+Background') no-repeat center/cover;
      position: relative; overflow: hidden;
    }
    #player {
      width: 40px; height: 40px;
      background: url('https://placehold.jp/40x40.png?text=Hero') no-repeat center/cover;
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      cursor: move;
    }

    /* 戦闘画面 */
    #battle-screen {
      display: none; /* 戦闘時に表示 */
      text-align: center; padding: 10px;
      background: #dff; height: 80vh;
      overflow-y: auto;
    }
    #dq-frame {
      width: 90%; max-width: 600px; margin: 10px auto;
      border: 2px solid #333; padding: 10px; background: #fff; border-radius: 8px;
    }
    #top-text-box {
      border: 1px solid #666; min-height: 60px;
      padding: 8px; margin-bottom: 10px; background: #eee;
    }
    .enemy-container {
      display: flex; justify-content: center;
      gap: 10px; margin-bottom: 10px;
    }
    .enemy {
      width: 60px; height: 60px;
      background: url('https://placehold.jp/60x60.png?text=Enemy') no-repeat center/cover;
    }
    #quiz-image {
      max-width: 80%; height: auto;
      margin: 10px 0;
    }
    .choice-button {
      display: block; width: 80%;
      max-width: 300px; margin: 5px auto; padding: 10px;
      font-size: 16px; cursor: pointer;
      background: #007bff; color: #fff; border: none; border-radius: 4px;
    }
    .choice-button:hover { background: #0056b3; }

    #zaoriku-button {
      display: none; margin-top: 10px;
      padding: 8px 16px; background: #f00; color: #fff;
      border: none; cursor: pointer; border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>ドラクエ風クイズゲーム - I列に間違い回数を更新</h1>
  <button id="login-btn">Googleでログイン</button>

  <!-- フィールド画面 -->
  <div id="field-screen">
    <div id="player"></div>
  </div>

  <!-- 戦闘画面 -->
  <div id="battle-screen">
    <div id="dq-frame">
      <div id="top-text-box">ここにテキストが表示されます</div>
      <!-- 敵4体を並べる -->
      <div class="enemy-container" id="enemy-row">
        <div class="enemy" id="enemy1"></div>
        <div class="enemy" id="enemy2"></div>
        <div class="enemy" id="enemy3"></div>
        <div class="enemy" id="enemy4"></div>
      </div>
      <!-- クイズ画像 -->
      <img id="quiz-image" src="" alt="クイズ画像" />
      <!-- 選択肢ボタン -->
      <div id="choice-area"></div>
      <!-- ザオリクボタン（ミスでHP0時） -->
      <button id="zaoriku-button">ザオリク？</button>
    </div>
  </div>

<script>
/*****************************************************************
 * 1) Google Sheets + Google Identity Services の設定
 *****************************************************************/
// ★★ スコープを "spreadsheets.readonly" から "spreadsheets" に変更
const SCOPES = "https://www.googleapis.com/auth/spreadsheets"; 

const CLIENT_ID   = "403866618480-7dhf5rl00k6shl8jmm16s6tvm8ef0odj.apps.googleusercontent.com";
const API_KEY     = "AIzaSyBszPu-BQ2_Aq9C3lhAiW--kyenM5vQsjs";
const SHEET_ID    = "1GyKDfVQCNrBlkxjsrQDv_ouIio9yjO3mVQy6Ds5uQzg";
const SHEET_NAME  = "sheet1";  // A:ID / B:問題文 / C:画像URL / D:選択肢1 / E:選択肢2 / F:選択肢3 / G:選択肢4 / H:正解 / I:間違え回数 / J:解説

// OAuth & GAPI
let tokenClient;
let gapiInited = false;
let gisInited  = false;

/*****************************************************************
 * 2) クイズデータ構造 (sheet1)
 *****************************************************************/
// 例: {
//   id: '1',
//   question: '問題文',
//   imageUrl: '画像URL',
//   choice1: '選択肢1',
//   choice2: '選択肢2',
//   choice3: '選択肢3',
//   choice4: '選択肢4',
//   correct: '2',
//   missed: '0',
//   info: '解説'
// }
let quizData = [];

/*****************************************************************
 * 3) フィールド画面のドラッグ移動 + ランダムエンカウント
 *****************************************************************/
let fieldScreen = document.getElementById("field-screen");
let player = document.getElementById("player");
let isDragging = false;
let offsetX = 0, offsetY = 0;

player.addEventListener("mousedown", (e) => {
  isDragging = true;
  offsetX = e.offsetX;
  offsetY = e.offsetY;
});
fieldScreen.addEventListener("mousemove", (e) => {
  if (isDragging) {
    player.style.left = (e.pageX - offsetX) + "px";
    player.style.top  = (e.pageY - offsetY) + "px";
    // ランダムエンカウント
    if (Math.random() < 0.01) {
      startBattle();
    }
  }
});
fieldScreen.addEventListener("mouseup", () => {
  isDragging = false;
});

/*****************************************************************
 * 4) 戦闘画面の要素
 *****************************************************************/
let battleScreen  = document.getElementById("battle-screen");
let topTextBox    = document.getElementById("top-text-box");
let quizImage     = document.getElementById("quiz-image");
let choiceArea    = document.getElementById("choice-area");
let zaorikuButton = document.getElementById("zaoriku-button");

// 敵4体
let currentEnemyIndex = 1;
let enemyCount = 4;

// HP/レベル/正解数 (localStorage)
let playerHP   = parseInt(localStorage.getItem("playerHP")   || "100", 10);
let playerLV   = parseInt(localStorage.getItem("playerLV")   || "1",   10);
let correctCnt = parseInt(localStorage.getItem("correctCnt") || "0",   10);

/*****************************************************************
 * 5) 戦闘開始
 *****************************************************************/
function startBattle() {
  fieldScreen.style.display = "none";
  battleScreen.style.display = "block";

  topTextBox.textContent = "モンスターがあらわれた！";
  // 敵4体をリセット
  currentEnemyIndex = 1;
  for (let i = 1; i <= 4; i++) {
    let en = document.getElementById("enemy" + i);
    en.style.background = "url('https://placehold.jp/60x60.png?text=Enemy') no-repeat center/cover";
    en.dataset.isDead = "false";
  }
  showQuiz();
}

/*****************************************************************
 * 6) クイズ表示
 *****************************************************************/
function showQuiz() {
  if (currentEnemyIndex > enemyCount) {
    // 敵全滅
    topTextBox.textContent = "敵をすべて倒した！";
    endBattle();
    return;
  }
  if (playerHP <= 0) {
    // プレイヤー倒れ
    topTextBox.textContent = "プレイヤーは倒れた...";
    zaorikuButton.style.display = "inline-block";
    choiceArea.innerHTML = "";
    return;
  }

  if (quizData.length === 0) {
    topTextBox.textContent = "問題データがありません。シートを確認してください。";
    return;
  }

  // ランダムに1問
  let q = quizData[Math.floor(Math.random() * quizData.length)];
  topTextBox.textContent = q.question || "問題文が空です";
  quizImage.src = q.imageUrl || "";

  choiceArea.innerHTML = "";
  for (let i = 1; i <= 4; i++) {
    let btn = document.createElement("button");
    btn.className = "choice-button";
    btn.textContent = q["choice" + i];
    btn.onclick = () => answerQuiz(q, i);
    choiceArea.appendChild(btn);
  }
}

/*****************************************************************
 * 7) 回答チェック
 *****************************************************************/
function answerQuiz(q, selected) {
  let correct = parseInt(q.correct, 10);
  if (selected === correct) {
    // 正解
    topTextBox.textContent = 正解！ 敵${currentEnemyIndex}は倒れた。;
    let en = document.getElementById("enemy" + currentEnemyIndex);
    if (en) {
      en.style.background = "url('https://placehold.jp/60x60.png?text=Dead') no-repeat center/cover";
      en.dataset.isDead = "true";
    }
    correctCnt++;
    localStorage.setItem("correctCnt", correctCnt);
    // 16回正解でレベルアップ
    if (correctCnt % 16 === 0) {
      playerLV++;
      localStorage.setItem("playerLV", playerLV);
      alert(レベルアップ！ 現在レベル: ${playerLV});
    }
    currentEnemyIndex++;
  } else {
    // 不正解
    shakeScreen();
    playerHP -= 25;
    localStorage.setItem("playerHP", playerHP);
    topTextBox.textContent = ミス！ プレイヤーに25のダメージ (HP:${playerHP});

    // 不正解回数を +1 してシートに書き込み
    let missedCount = parseInt(q.missed, 10) || 0;
    missedCount++;
    q.missed = missedCount; // ローカルデータ更新
    updateMissedCount(q.id, missedCount);
  }

  setTimeout(() => {
    showQuiz();
  }, 1000);
}

// 不正解時に I 列(間違え回数) を更新する
async function updateMissedCount(questionID, newMissedCount) {
  // quizData配列から対象の行を探す
  let idx = quizData.findIndex(item => item.id === questionID);
  if (idx === -1) return;

  // シート上の行番号 = idx + 2 (1行目は見出し)
  let rowNum = idx + 2;
  let range = ${SHEET_NAME}!I${rowNum}; // I列が間違い回数

  try {
    // values.update で単セルを更新
    let result = await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SHEET_ID,
      range: range,
      valueInputOption: "USER_ENTERED",
      values: [[ newMissedCount ]]
    });
    console.log(I列に間違い回数(${newMissedCount})を更新: row=${rowNum}, result);
  } catch (err) {
    console.error("I列更新エラー:", err);
  }
}

/*****************************************************************
 * 8) 画面シェイク
 *****************************************************************/
function shakeScreen() {
  battleScreen.style.animation = "shake 0.5s";
  setTimeout(() => {
    battleScreen.style.animation = "";
  }, 500);
}
const style = document.createElement("style");
style.innerHTML = 
@keyframes shake {
  0% { transform: translate(0, 0); }
  20% { transform: translate(-10px, 0); }
  40% { transform: translate(10px, 0); }
  60% { transform: translate(-10px, 0); }
  80% { transform: translate(10px, 0); }
  100% { transform: translate(0, 0); }
}
;
document.head.appendChild(style);

/*****************************************************************
 * 9) 戦闘終了 → フィールドへ
 *****************************************************************/
function endBattle() {
  setTimeout(() => {
    battleScreen.style.display = "none";
    fieldScreen.style.display   = "block";
  }, 1500);
}

/*****************************************************************
 * 10) ザオリクボタン
 *****************************************************************/
zaorikuButton.onclick = function() {
  playerHP = 100;
  localStorage.setItem("playerHP", playerHP);
  zaorikuButton.style.display = "none";
  endBattle();
};

/*****************************************************************
 * 11) Sheets からクイズデータを読み込む (書き込みもするので注意)
 *****************************************************************/
async function loadQuizDataFromSheets() {
  try {
    const resp = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: ${SHEET_NAME}!A1:J1000
    });
    const values = resp.result.values;
    if (!values || values.length < 2) {
      console.error("シートにデータがありません");
      return;
    }
    // 1行目は見出し: A:ID / B:問題文 / C:画像URL / D:選択肢1 / E:選択肢2 / F:選択肢3 / G:選択肢4 / H:正解 / I:間違え回数 / J:解説
    quizData = values.slice(1).map((row, i) => ({
      id:       row[0] || "",
      question: row[1] || "",
      imageUrl: row[2] || "",
      choice1:  row[3] || "",
      choice2:  row[4] || "",
      choice3:  row[5] || "",
      choice4:  row[6] || "",
      correct:  row[7] || "1",  // 正解
      missed:   row[8] || "0",  // 間違え回数
      info:     row[9] || ""    // 解説
    }));
    console.log("取得したクイズデータ:", quizData);
  } catch (err) {
    console.error("Sheets API Error:", err);
  }
}

/*****************************************************************
 * 12) Google API 初期化 (書き込みスコープ)
 *****************************************************************/
function gapiLoaded() {
  console.log("gapiLoaded() called");
  gapi.load("client", async () => {
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
    });
    gapiInited = true;
    maybeEnableButton();
  });
}

function gisLoaded() {
  console.log("gisLoaded() called");
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES, // "https://www.googleapis.com/auth/spreadsheets"
    callback: async (resp) => {
      if (resp.error) {
        console.error("Token Error:", resp);
        return;
      }
      console.log("Access Token:", resp.access_token);
      gapi.client.setToken({ access_token: resp.access_token });
      await loadQuizDataFromSheets(); // 読み込み
    }
  });
  gisInited = true;
  maybeEnableButton();
}

function maybeEnableButton() {
  const loginBtn = document.getElementById("login-btn");
  if (gapiInited && gisInited) {
    loginBtn.style.display = "inline-block";
    loginBtn.onclick = () => {
      tokenClient.requestAccessToken({ prompt: '' });
    };
  }
}

/*****************************************************************
 * 13) onload で何もしない
 *****************************************************************/
window.addEventListener("load", () => {
  // ...
});
</script>

<!-- GAPI 読み込み -->
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<!-- Google Identity Services 読み込み -->
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
