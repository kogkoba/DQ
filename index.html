<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ドラクエ風クイズゲーム - I列に間違い回数を更新</title>
  <script async defer src="https://accounts.google.com/gsi/client"></script>
  <script async defer src="https://apis.google.com/js/api.js"></script>
  <style>
    body {
      margin: 0; padding: 0; font-family: sans-serif;
      background-color: #f0f8ff;
    }
    h1 { text-align: center; margin-top: 10px; }
    .choice-button {
      display: block; width: 80%; max-width: 300px;
      margin: 5px auto; padding: 10px;
      font-size: 16px; cursor: pointer;
      background: #007bff; color: #fff;
      border: none; border-radius: 4px;
    }
    .choice-button:hover { background: #0056b3; }
    #quiz-image { max-width: 80%; height: auto; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>ドラクエ風クイズゲーム - I列に間違い回数を更新</h1>
  <button id="login-btn">Googleでログイン</button>
  <div id="battle-screen">
    <div id="dq-frame">
      <div id="top-text-box">ここにテキストが表示されます</div>
      <img id="quiz-image" src="" alt="クイズ画像" />
      <div id="choice-area"></div>
    </div>
  </div>

<script>
const CLIENT_ID = "YOUR_CLIENT_ID";
const API_KEY = "YOUR_API_KEY";
const SHEET_ID = "YOUR_SHEET_ID";
const SHEET_NAME = "sheet1";
let quizData = [];
let tokenClient;

async function loadQuizDataFromSheets() {
  try {
    const resp = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: `${SHEET_NAME}!A1:J1000`
    });
    const values = resp.result.values;
    if (!values || values.length < 2) {
      console.error("シートにデータがありません");
      return;
    }
    quizData = values.slice(1).map(row => ({
      id: row[0] || "",
      question: row[1] || "",
      imageUrl: row[2] || "",
      choice1: row[3] || "",
      choice2: row[4] || "",
      choice3: row[5] || "",
      choice4: row[6] || "",
      correct: row[7] || "1"
    }));
    console.log("取得したクイズデータ:", quizData);
  } catch (err) {
    console.error("Sheets API Error:", err);
  }
}

function showQuiz() {
  if (quizData.length === 0) {
    topTextBox.textContent = "問題データがありません。シートを確認してください。";
    return;
  }
  let q = quizData[Math.floor(Math.random() * quizData.length)];
  topTextBox.textContent = q.question || "問題文が空です";
  
  let imageUrl = q.imageUrl;
  if (imageUrl.includes("drive.google.com")) {
    let fileId = imageUrl.match(/id=([a-zA-Z0-9_-]+)/);
    if (fileId && fileId[1]) {
      imageUrl = `https://drive.google.com/thumbnail?id=${fileId[1]}&sz=w1000`;
    }
  }
  console.log("変換後の画像URL:", imageUrl);
  document.getElementById("quiz-image").src = imageUrl || "https://placehold.jp/300x200.png?text=No+Image";

  let choiceArea = document.getElementById("choice-area");
  choiceArea.innerHTML = "";
  for (let i = 1; i <= 4; i++) {
    let btn = document.createElement("button");
    btn.className = "choice-button";
    btn.textContent = q["choice" + i];
    btn.onclick = () => checkAnswer(q, i);
    choiceArea.appendChild(btn);
  }
}

function checkAnswer(q, selected) {
  if (selected == q.correct) {
    alert("正解！");
  } else {
    alert("不正解！");
  }
  showQuiz();
}

function gapiLoaded() {
  gapi.load("client", async () => {
    await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
    await loadQuizDataFromSheets();
  });
}

function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: "https://www.googleapis.com/auth/spreadsheets",
    callback: async (resp) => {
      if (resp.error) {
        console.error("Token Error:", resp);
        return;
      }
      gapi.client.setToken({ access_token: resp.access_token });
      await loadQuizDataFromSheets();
    }
  });
  document.getElementById("login-btn").style.display = "inline-block";
  document.getElementById("login-btn").onclick = () => {
    tokenClient.requestAccessToken({ prompt: '' });
  };
}

window.addEventListener("load", showQuiz);
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
