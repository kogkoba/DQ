<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ãƒ‰ãƒ©ã‚¯ã‚¨é¢¨ã‚¯ã‚¤ã‚ºã‚²ãƒ¼ãƒ </title>

  <!-- Google API (å¤ã„GAPIæ–¹å¼) -->
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <style>
    body {
      text-align: center;
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    #question-container {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: 20px auto;
    }
    #question-image {
      max-width: 100%;
      height: auto;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .choice {
      display: block;
      width: 100%;
      margin: 5px 0;
      padding: 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    .choice:hover {
      background: #0056b3;
    }
    /* ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #login-btn, #logout-btn {
      margin-bottom: 10px;
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
    }
    #login-btn {
      background-color: #4285f4;
      color: white;
    }
    #logout-btn {
      background-color: #db4437;
      color: white;
    }
    /* ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é ˜åŸŸ */
    #debug {
      margin: 10px auto;
      max-width: 600px;
      text-align: left;
      background: #eee;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      color: #333;
      white-space: pre-wrap; /* æ”¹è¡Œã‚’åæ˜  */
    }
  </style>
</head>
<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ -->
  <button id="login-btn" style="display:none;">Google ã§ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button id="logout-btn" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

  <h1>ãƒ‰ãƒ©ã‚¯ã‚¨é¢¨ã‚¯ã‚¤ã‚ºã‚²ãƒ¼ãƒ </h1>

  <div id="question-container" style="display:none;">
    <h2 id="question"></h2>
    <img id="question-image" width="200" alt="Question Image" /><br />
    <div id="choices"></div>
  </div>

  <!-- ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºç”¨ -->
  <div id="debug"></div>

  <script>
    (function() {
      // â˜…â˜…â˜… å¿…è¦ã«å¿œã˜ã¦ä»¥ä¸‹ã®å„å®šæ•°ã‚’è¨­å®š â˜…â˜…â˜…
      const SHEET_ID   = "1GyKDfVQCNrBlkxjsrQDv_ouIio9yjO3mVQy6Ds5uQzg"; // ã‚ãªãŸã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
      const CLIENT_ID  = "403866618480-7dhf5rl00k6shl8jmm16s6tvm8ef0odj.apps.googleusercontent.com"; // ã‚ãªãŸã®OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
      const API_KEY    = "AIzaSyBszPu-BQ2_Aq9C3lhAiW--kyenM5vQsjs";      // ã‚ãªãŸã®APIã‚­ãƒ¼
      const SHEET_NAME = "DQquestion"; // ã‚·ãƒ¼ãƒˆå

      const DISCOVERY_DOCS = [
        "https://sheets.googleapis.com/$discovery/rest?version=v4"
      ];
      const SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email";

      // DOMè¦ç´ ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      const loginBtn          = document.getElementById("login-btn");
      const logoutBtn         = document.getElementById("logout-btn");
      const questionContainer = document.getElementById("question-container");
      const questionEl        = document.getElementById("question");
      const questionImageEl   = document.getElementById("question-image");
      const choicesDiv        = document.getElementById("choices");
      const debugDiv          = document.getElementById("debug");

      // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
      function debugLog(message) {
        console.log(message);
        debugDiv.textContent += message + "\n";
      }

      // Google API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
      function initClient() {
        debugLog("initClient() called.");
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(() => {
          debugLog("gapi.client.init -> success");
          const authInstance = gapi.auth2.getAuthInstance();
          authInstance.isSignedIn.listen(updateSigninStatus);
          updateSigninStatus(authInstance.isSignedIn.get());
        }).catch(error => {
          debugLog("Google API åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + JSON.stringify(error));
          console.error("Google API åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼", error);
        });
      }

      // ã‚µã‚¤ãƒ³ã‚¤ãƒ³çŠ¶æ…‹ã«å¿œã˜ãŸUIæ›´æ–°
      function updateSigninStatus(isSignedIn) {
        debugLog("updateSigninStatus: " + isSignedIn);
        if (isSignedIn) {
          loginBtn.style.display = "none";
          logoutBtn.style.display = "inline-block";
          questionContainer.style.display = "block";
          fetchQuizData();
        } else {
          loginBtn.style.display = "inline-block";
          logoutBtn.style.display = "none";
          questionContainer.style.display = "none";
        }
      }

      // ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
      window.handleAuthClick = function() {
        debugLog("handleAuthClick() -> signIn");
        gapi.auth2.getAuthInstance().signIn();
      };

      window.handleSignoutClick = function() {
        debugLog("handleSignoutClick() -> signOut");
        gapi.auth2.getAuthInstance().signOut();
      };

      // APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ­ãƒ¼ãƒ‰
      function handleClientLoad() {
        debugLog("handleClientLoad() called. Now loading client:auth2...");
        gapi.load("client:auth2", initClient);
      }

      // Google Sheets ã‹ã‚‰ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      function fetchQuizData() {
        debugLog("fetchQuizData() called. Requesting Sheets data...");
        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SHEET_ID,
          range: `${SHEET_NAME}!A1:J1000`
        }).then(response => {
          debugLog("Sheets data fetch -> success");
          const values = response.result.values;
          if (!values || values.length < 2) {
            debugLog("ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™");
            console.error("ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™");
            return;
          }
          startQuiz(values);
        }).catch(error => {
          debugLog("Google Sheets å–å¾—ã‚¨ãƒ©ãƒ¼: " + JSON.stringify(error));
          console.error("Google Sheets å–å¾—ã‚¨ãƒ©ãƒ¼", error);
        });
      }

      // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¯ã‚¤ã‚ºã‚’é¸ã³ã€å•é¡Œæ–‡ã¨é¸æŠè‚¢ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      function startQuiz(data) {
        debugLog("startQuiz() called.");
        const quizList = data.slice(1).map(row => ({
          "å•é¡Œæ–‡": row[1],
          "ç”»åƒURL": row[2],
          "é¸æŠè‚¢1": row[3],
          "é¸æŠè‚¢2": row[4],
          "é¸æŠè‚¢3": row[5],
          "é¸æŠè‚¢4": row[6],
          "æ­£è§£": row[7],
          "è§£èª¬": row[9]
        }));

        // ãƒ©ãƒ³ãƒ€ãƒ ã«1å•é¸ã¶
        const quiz = quizList[Math.floor(Math.random() * quizList.length)];
        questionEl.textContent = quiz["å•é¡Œæ–‡"] || "å•é¡Œæ–‡ãŒã‚ã‚Šã¾ã›ã‚“";
        questionImageEl.src = quiz["ç”»åƒURL"] || "";
        choicesDiv.innerHTML = "";

        for (let i = 1; i <= 4; i++) {
          const choiceText = quiz[`é¸æŠè‚¢${i}`] || `é¸æŠè‚¢${i}ãŒç©ºã§ã™`;
          const btn = document.createElement("button");
          btn.textContent = choiceText;
          btn.className = "choice";
          btn.addEventListener("click", () => checkAnswer(quiz, i));
          choicesDiv.appendChild(btn);
        }
      }

      // å›ç­”ãƒã‚§ãƒƒã‚¯ã¨çµæœè¡¨ç¤º
      function checkAnswer(quiz, selected) {
        debugLog("checkAnswer() called. selected=" + selected);
        let resultMessage = "";
        if (parseInt(quiz["æ­£è§£"], 10) === selected) {
          resultMessage = "âœ… æ­£è§£ï¼ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’å€’ã—ãŸï¼";
        } else {
          const correctChoice = quiz["é¸æŠè‚¢" + quiz["æ­£è§£"]];
          resultMessage = `âŒ ä¸æ­£è§£ï¼\næ­£è§£ã¯ã€Œ${correctChoice}ã€ã§ã™ã€‚\n\nğŸ” è§£èª¬: ${quiz["è§£èª¬"]}`;
        }
        alert(resultMessage);
        // æ¬¡ã®ã‚¯ã‚¤ã‚ºã‚’å–å¾—
        fetchQuizData();
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã« Google API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
      window.addEventListener("load", () => {
        debugLog("window onload -> handleClientLoad()");
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã« onclick ã‚’å‰²ã‚Šå½“ã¦ï¼ˆHTMLå†…ã«ç›´æ¥æ›¸ã„ã¦ã‚‚OKï¼‰
        loginBtn.onclick = window.handleAuthClick;
        logoutBtn.onclick = window.handleSignoutClick;
        handleClientLoad();
      });
    })();
  </script>
</body>
</html>